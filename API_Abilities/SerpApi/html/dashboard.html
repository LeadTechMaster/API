<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SerpApi Market Intelligence - Miami Moving Companies</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Mapbox GL JS -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }

        .header {
            background: white;
            border-bottom: 1px solid #d2d2d7;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 22px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #34c759;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #0051d5;
        }

        .btn-secondary {
            background: #f5f5f7;
            color: #1d1d1f;
            border: 1px solid #d2d2d7;
        }

        .btn-secondary:hover {
            background: #e8e8ed;
        }

        .btn-danger {
            background: #ff3b30;
        }

        .btn-danger:hover {
            background: #d3160a;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #d2d2d7;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e5e7;
        }

        .section-title {
            font-size: 17px;
            font-weight: 600;
            color: #1d1d1f;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-meta {
            font-size: 12px;
            color: #86868b;
            display: flex;
            gap: 12px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .cache-badge {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .cached {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .fresh {
            background: #fff3e0;
            color: #e65100;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .table th {
            text-align: left;
            padding: 10px;
            background: #f5f5f7;
            font-weight: 600;
            color: #1d1d1f;
            border-bottom: 1px solid #d2d2d7;
        }

        .table td {
            padding: 10px;
            border-bottom: 1px solid #e5e5e7;
        }

        .table tr:hover {
            background: #f9f9f9;
        }

        .rating {
            color: #ff9500;
            font-weight: 600;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-box {
            background: #f5f5f7;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #007aff;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .keyword-pill {
            display: inline-block;
            padding: 6px 12px;
            background: #007aff;
            color: white;
            border-radius: 16px;
            font-size: 12px;
            margin: 4px;
        }

        .explanation {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #007aff;
            margin-bottom: 16px;
            font-size: 13px;
            color: #515154;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 16px;
        }
        
        .map-container {
            width: 100%;
            height: 600px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .map-control-btn {
            padding: 8px 12px;
            background: #f5f5f7;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .map-control-btn:hover {
            background: #e5e5e7;
        }
        
        .map-control-btn.active {
            background: #007aff;
            color: white;
        }
        
        .mapboxgl-popup-content {
            padding: 12px;
            border-radius: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #e5e5e7;
            border-top: 3px solid #007aff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-box {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            padding: 12px;
            border-radius: 8px;
            color: #c53030;
            font-size: 13px;
        }

        .success-box {
            background: #f0fdf4;
            border: 1px solid #86efac;
            padding: 12px;
            border-radius: 8px;
            color: #166534;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div>
                <h1>üìä SerpApi Market Intelligence Dashboard</h1>
                <p style="font-size: 13px; color: #86868b; margin-top: 4px;">Miami Moving Companies | 25+ Real APIs | Database Integrated</p>
            </div>
            <div class="status-badge">
                <div class="status-dot"></div>
                <span>LIVE DATA</span>
            </div>
        </div>
        <div class="controls">
            <button class="btn" onclick="loadOverview()">üìä Overview</button>
            <button class="btn" onclick="loadVolumeAnalytics()">üìà Volume & Trends</button>
            <button class="btn" onclick="loadCompetitorIntel()">üéØ Competitors</button>
            <button class="btn" onclick="loadKeywordResearch()">üí° Keywords</button>
            <button class="btn" onclick="loadMediaAnalysis()">üñºÔ∏è Media</button>
            <button class="btn btn-secondary" onclick="loadAllDetailed()">üìã All Data</button>
            <button class="btn" onclick="loadCompleteIntelligence()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">üß† Complete Intelligence</button>
            <button class="btn" onclick="loadMarketingAnalytics()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">üìä Marketing Analytics</button>
            <button class="btn" onclick="loadMiamiMap()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">üó∫Ô∏è Miami Map</button>
            <button class="btn btn-danger" onclick="forceRefreshAll()">üîÑ Force Refresh</button>
        </div>
    </div>

    <div class="container">
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p style="color: #86868b;">Loading real-time data...</p>
        </div>

        <div id="dataContainer"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001/api';
        let currentView = 'overview';

        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('dataContainer').innerHTML = '';
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        function getTimestamp(data) {
            if (data.from_cache) {
                const ageMin = data.age_minutes || 0;
                return `üíæ Cached (${ageMin}min ago)`;
            }
            return `üîÑ Fresh (${data.response_time_ms || 0}ms)`;
        }

        function createSection(title, explain, content, metadata = null) {
            const metaHtml = metadata ? `
                <div class="section-meta">
                    <span class="meta-item">
                        <span class="cache-badge ${metadata.from_cache ? 'cached' : 'fresh'}">
                            ${metadata.from_cache ? 'üíæ Cached' : 'üîÑ Fresh'}
                        </span>
                    </span>
                    ${metadata.age_minutes !== undefined ? `<span class="meta-item">üìÖ ${metadata.age_minutes}min ago</span>` : ''}
                    ${metadata.response_time_ms ? `<span class="meta-item">‚ö° ${metadata.response_time_ms}ms</span>` : ''}
                </div>
            ` : '';

            return `
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">${title}</div>
                        ${metaHtml}
                    </div>
                    ${explain ? `<div class="explanation">${explain}</div>` : ''}
                    ${content}
                </div>
            `;
        }

        async function loadOverview() {
            showLoading();
            currentView = 'overview';
            
            try {
                // Load ALL core data in parallel
                const [search, local, difficulty, serp, keywords, related, paa, yelp, news, images] = await Promise.all([
                    fetch(`${API_BASE}/google-search`).then(r => r.json()),
                    fetch(`${API_BASE}/local-businesses`).then(r => r.json()),
                    fetch(`${API_BASE}/keyword-difficulty`).then(r => r.json()),
                    fetch(`${API_BASE}/serp-analysis`).then(r => r.json()),
                    fetch(`${API_BASE}/keyword-suggestions`).then(r => r.json()),
                    fetch(`${API_BASE}/related-searches`).then(r => r.json()),
                    fetch(`${API_BASE}/people-also-ask`).then(r => r.json()),
                    fetch(`${API_BASE}/yelp-businesses`).then(r => r.json()),
                    fetch(`${API_BASE}/news-search`).then(r => r.json()),
                    fetch(`${API_BASE}/image-search`).then(r => r.json())
                ]);

                hideLoading();

                let html = '';
                
                // System Status Banner
                html += `
                    <div class="section" style="background: linear-gradient(135deg, #007aff 0%, #5856d6 100%); color: white;">
                        <h2 style="margin: 0 0 12px 0;">üìä Complete Data Overview - Last Updated: ${new Date().toLocaleString()}</h2>
                        <div class="stat-grid">
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">${local.total_results || 0}</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Businesses</div>
                            </div>
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">${keywords.total_suggestions || 0}</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Keywords</div>
                            </div>
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">${images.total_images || 0}</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Images</div>
                            </div>
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">${news.total_results || 0}</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">News</div>
                            </div>
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">${yelp.total_results || 0}</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Yelp Reviews</div>
                            </div>
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">${difficulty.difficulty_score}/100</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">${difficulty.difficulty_level}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Market Overview Stats
                html += createSection(
                    'üéØ Market Snapshot',
                    'Real-time snapshot of the Miami moving industry. All data from live APIs, cached for 15 minutes.',
                    renderMarketStats(search, local, difficulty)
                );

                // Top Competitors Table
                html += createSection(
                    'üè¢ Top 20 Movers - Google Maps (Full Database)',
                    `All ${local.total_results} moving companies with complete profiles. Last API refresh: ${getTimestamp(local)}. Database stores: business name, rating, review count, phone, address, GPS coordinates, hours, website, service options.`,
                    renderLocalTable(local),
                    local
                );

                // Yelp Data
                html += createSection(
                    '‚≠ê Yelp Business Intelligence',
                    `${yelp.total_results} businesses from Yelp with ratings and reviews. Compare with Google Maps data to identify discrepancies. Last refresh: ${getTimestamp(yelp)}.`,
                    renderYelpTable(yelp),
                    yelp
                );

                // Keyword Analysis
                html += createSection(
                    'üéØ Keyword Difficulty - "moving companies miami"',
                    `SEO difficulty: ${difficulty.difficulty_score}/100 (${difficulty.difficulty_level}). Data from SERP analysis. Last refresh: ${getTimestamp(difficulty)}.`,
                    renderDifficultyCompact(difficulty),
                    difficulty
                );

                // SERP Features
                html += createSection(
                    'üìä SERP Features Analysis',
                    `What appears in Google results. Last checked: ${getTimestamp(serp)}. Features detected affect SEO strategy.`,
                    renderSerpFeatures(serp),
                    serp
                );

                // Keywords
                html += createSection(
                    'üí° Keyword Suggestions (${keywords.total_suggestions} ideas)',
                    `Autocomplete-based suggestions from Google. Last refresh: ${getTimestamp(keywords)}. Database stores: keyword, relevance, timestamp.`,
                    `<div>${keywords.suggestions.map(kw => `<span class="keyword-pill">${kw}</span>`).join('')}</div>`,
                    keywords
                );

                // Related Searches
                html += createSection(
                    'üîó Related Searches (${related.total_related} queries)',
                    `What users are searching for. Last refresh: ${getTimestamp(related)}. Use for content strategy and PPC.`,
                    `<div>${related.related_searches.map(s => `<span class="keyword-pill">${s.query}</span>`).join('')}</div>`,
                    related
                );

                // People Also Ask
                html += createSection(
                    '‚ùì People Also Ask (${paa.total_questions} questions)',
                    `Common FAQ questions. Last refresh: ${getTimestamp(paa)}. Create content to capture featured snippets.`,
                    renderPAATable(paa),
                    paa
                );

                // News
                html += createSection(
                    'üì∞ Industry News (Last 30 Days)',
                    `${news.total_results} recent articles. Last refresh: ${getTimestamp(news)}. Track competitor announcements and industry trends.`,
                    renderNewsTable(news),
                    news
                );

                // Images Preview
                html += createSection(
                    'üñºÔ∏è Visual Content (${images.total_images} images)',
                    `Competitor branding and marketing materials. Last refresh: ${getTimestamp(images)}. First 20 shown.`,
                    renderImagesCompact(images),
                    images
                );

                // Data Types Overview for Marketing Managers
                html += createSection(
                    'üìã Data Types & API Coverage',
                    'Complete overview of all available data types for marketing managers - click "üìä Marketing Analytics" for detailed analysis',
                    renderDataTypesOverview(),
                    { from_cache: false, age_minutes: 0, response_time_ms: 0, saved_to_db: true }
                );

                // Abilities & Examples - one-stop overview of ALL endpoints
                html += createSection(
                    'üß© Abilities & Examples (All APIs)',
                    'Every capability in one place: example query, endpoint, and DB table for auditability.',
                    renderAbilitiesExamples(),
                    { from_cache: false, age_minutes: 0, response_time_ms: 0, saved_to_db: true }
                );

                document.getElementById('dataContainer').innerHTML = html;
                
            } catch (error) {
                hideLoading();
                document.getElementById('dataContainer').innerHTML = `
                    <div class="error-box">Error: ${error.message}</div>
                `;
            }
        }

        // Render ALL abilities with example, endpoint and DB storage
        function renderAbilitiesExamples() {
            const items = [
                { name: 'Google Search', example: '"moving companies miami"', endpoint: '/api/google-search', tables: ['api_calls'], notes: 'Organic results snapshot' },
                { name: 'Local Businesses (Google Maps)', example: 'q=moving companies, ll=@25.7617,-80.1918,15z', endpoint: '/api/local-businesses', tables: ['local_businesses','api_calls'], notes: 'Full business profiles' },
                { name: 'Yelp Businesses', example: 'term=movers, location=Miami, FL', endpoint: '/api/yelp-businesses', tables: ['yelp_businesses','api_calls'], notes: 'Cross-validate ratings' },
                { name: 'Keyword Difficulty', example: '"moving companies miami"', endpoint: '/api/keyword-difficulty', tables: ['keywords','api_calls'], notes: '0-100 difficulty' },
                { name: 'SERP Analysis', example: 'SERP features for main query', endpoint: '/api/serp-analysis', tables: ['serp_features','api_calls'], notes: 'Ads, PAA, Local Pack' },
                { name: 'Keyword Suggestions', example: 'seed="moving companies"', endpoint: '/api/keyword-suggestions', tables: ['keyword_suggestions','api_calls'], notes: 'Autocomplete ideas' },
                { name: 'Related Searches', example: 'related to main query', endpoint: '/api/related-searches', tables: ['related_searches','api_calls'], notes: 'Query expansion' },
                { name: 'People Also Ask', example: 'FAQ for main query', endpoint: '/api/people-also-ask', tables: ['people_also_ask','api_calls'], notes: 'Content for snippets' },
                { name: 'Images', example: 'brand visual assets', endpoint: '/api/image-search', tables: ['images','api_calls'], notes: 'Brand and creative' },
                { name: 'News', example: 'industry news 30 days', endpoint: '/api/news-search', tables: ['news','api_calls'], notes: 'Trends & PR' },
                { name: 'Shopping', example: 'moving supplies', endpoint: '/api/shopping-search', tables: ['shopping','api_calls'], notes: 'Price landscape' },
                { name: 'Google Jobs', example: 'movers miami', endpoint: '/api/google-jobs', tables: ['jobs','api_calls'], notes: 'Hiring signals' },
                { name: 'LinkedIn Jobs', example: 'moving companies miami', endpoint: '/api/linkedin-jobs', tables: ['linkedin_jobs','api_calls'], notes: 'Pro roles' },
                { name: 'YouTube', example: 'moving companies miami', endpoint: '/api/youtube-search', tables: ['youtube_videos','api_calls'], notes: 'Content strategy' },
                { name: 'Apple App Store', example: 'moving', endpoint: '/api/apple-apps', tables: ['app_store_apple','api_calls'], notes: 'iOS apps' },
                { name: 'Google Play', example: 'moving', endpoint: '/api/google-play-apps', tables: ['app_store_google','api_calls'], notes: 'Android apps' },
                { name: 'Google Patents', example: 'moving equipment', endpoint: '/api/patents', tables: ['patents','api_calls'], notes: 'Innovation signals' },
                { name: 'Amazon Products', example: 'moving boxes', endpoint: '/api/amazon-products', tables: ['amazon_products','api_calls'], notes: 'Retail pricing' },
                { name: 'Walmart Products', example: 'moving boxes', endpoint: '/api/walmart-products', tables: ['walmart_products','api_calls'], notes: 'Supply pricing' },
                { name: 'Search Trends', example: 'time-series interest', endpoint: '/api/search-trends', tables: ['keyword_volume_history','api_calls'], notes: 'Volume over time' },
                { name: 'Regional Interest', example: 'by state', endpoint: '/api/regional-interest', tables: ['regional_interest','api_calls'], notes: 'Geo opportunities' },
                { name: 'Bing Search', example: 'moving companies miami', endpoint: '/api/bing-search', tables: ['api_calls'], notes: 'Alt engine' },
                { name: 'DuckDuckGo', example: 'moving companies miami', endpoint: '/api/duckduckgo-search', tables: ['api_calls'], notes: 'Privacy engine' },
                { name: 'Google Scholar', example: 'logistics moving', endpoint: '/api/google-scholar', tables: ['scholar_papers','api_calls'], notes: 'Academic insights' },
                { name: 'Google Finance', example: 'transportation', endpoint: '/api/google-finance', tables: ['finance_news','stocks','api_calls'], notes: 'Market trends' },
                { name: 'Marketing Analytics', example: 'aggregated insights', endpoint: '/api/marketing-analytics', tables: ['analytics_snapshots','api_calls'], notes: 'Cross-API cards' },
                { name: 'Miami Map', example: 'geo viz', endpoint: '/api/miami-map-data', tables: ['local_businesses','yelp_businesses','keywords','regional_interest'], notes: 'Heatmap + clusters' }
            ];

            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px;">
            `;
            items.forEach((it) => {
                html += `
                    <div style="border:1px solid #e5e7eb; border-radius:8px; padding:12px; background:#fff;">
                        <div style="font-weight:600; color:#111827; margin-bottom:6px;">${it.name}</div>
                        <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">Example: <code>${it.example}</code></div>
                        <div style="font-size:12px; color:#374151; margin-bottom:6px;">Endpoint: <code>${it.endpoint}</code></div>
                        <div style="font-size:12px; color:#6b7280;">DB: ${it.tables.map(t => `<span style='background:#f3f4f6;padding:2px 6px;border-radius:4px;margin-right:4px;'>${t}</span>`).join('')}</div>
                        <div style="font-size:12px; color:#6b7280; margin-top:6px;">${it.notes}</div>
                    </div>
                `;
            });

            html += `</div>`;
            return html;
        }

        function renderYelpTable(data) {
            if (!data.businesses || data.businesses.length === 0) {
                return '<p style="color: #86868b;">No Yelp data available</p>';
            }

            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Business</th>
                            <th>Rating</th>
                            <th>Reviews</th>
                            <th>Price</th>
                            <th>Phone</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.businesses.forEach((biz, i) => {
                html += `
                    <tr>
                        <td>${i + 1}</td>
                        <td><strong>${biz.business_name}</strong></td>
                        <td class="rating">‚≠ê ${biz.rating || 'N/A'}</td>
                        <td>${(biz.reviews_count || 0).toLocaleString()}</td>
                        <td>${biz.price_range || 'N/A'}</td>
                        <td>${biz.phone || 'N/A'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            return html;
        }

        function renderPAATable(data) {
            if (!data.questions || data.questions.length === 0) {
                return '<p style="color: #86868b;">No questions available</p>';
            }

            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Answer Preview</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.questions.forEach(q => {
                html += `
                    <tr>
                        <td><strong>${q.question}</strong></td>
                        <td style="font-size: 12px; color: #86868b;">${q.answer ? q.answer.substring(0, 150) + '...' : 'N/A'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            return html;
        }

        function renderNewsTable(data) {
            if (!data.news || data.news.length === 0) {
                return '<p style="color: #86868b;">No news available</p>';
            }

            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Headline</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.news.forEach(article => {
                html += `
                    <tr>
                        <td style="white-space: nowrap; font-size: 12px;">${article.date || 'Recent'}</td>
                        <td><strong>${article.title}</strong></td>
                        <td style="font-size: 12px;">${article.source}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            return html;
        }

        function renderImagesCompact(data) {
            if (!data.images || data.images.length === 0) {
                return '<p style="color: #86868b;">No images available</p>';
            }

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px;">
                    ${data.images.slice(0, 20).map(img => `
                        <div style="position: relative;">
                            <img src="${img.thumbnail}" alt="${img.title}" 
                                 style="width: 100%; height: 100px; object-fit: cover; border-radius: 6px;" 
                                 title="${img.title}">
                            <div style="font-size: 10px; margin-top: 4px; color: #86868b; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${img.source || 'N/A'}</div>
                        </div>
                    `).join('')}
                </div>
                <p style="font-size: 12px; color: #86868b; margin-top: 12px;">Showing 20 of ${data.total_images} total images. Database stores: title, thumbnail URL, original URL, source, position, timestamp.</p>
            `;
        }

        function renderMarketStats(search, local, difficulty) {
            const avgRating = local.businesses ? 
                (local.businesses.reduce((sum, b) => sum + (b.rating || 0), 0) / local.businesses.length).toFixed(1) : 
                'N/A';
            
            const totalReviews = local.businesses ? 
                local.businesses.reduce((sum, b) => sum + (b.reviews || 0), 0) : 0;

            return `
                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-number">${local.total_results || 0}</div>
                        <div class="stat-label">Businesses Found</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${avgRating}</div>
                        <div class="stat-label">Avg Rating</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${totalReviews.toLocaleString()}</div>
                        <div class="stat-label">Total Reviews</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${difficulty.difficulty_score}/100</div>
                        <div class="stat-label">${difficulty.difficulty_level} Difficulty</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${search.total_results || 0}</div>
                        <div class="stat-label">Organic Results</div>
                    </div>
                </div>
            `;
        }

        function renderLocalTable(data) {
            if (!data.businesses || data.businesses.length === 0) {
                return '<p style="color: #86868b;">No businesses found</p>';
            }

            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Business Name</th>
                            <th>Rating</th>
                            <th>Reviews</th>
                            <th>Phone</th>
                            <th>Address</th>
                            <th>Hours</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.businesses.forEach((biz, i) => {
                html += `
                    <tr>
                        <td>${i + 1}</td>
                        <td><strong>${biz.title}</strong></td>
                        <td class="rating">‚≠ê ${biz.rating || 'N/A'}</td>
                        <td>${(biz.reviews || 0).toLocaleString()}</td>
                        <td>${biz.phone || 'N/A'}</td>
                        <td style="font-size: 12px;">${biz.address || 'N/A'}</td>
                        <td style="font-size: 11px;">${biz.hours || 'N/A'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            return html;
        }

        function renderDifficultyCompact(data) {
            const metrics = data.metrics || {};
            
            return `
                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-number">${data.difficulty_score}</div>
                        <div class="stat-label">Score (0-100)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${metrics.num_ads || 0}</div>
                        <div class="stat-label">Paid Ads</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${metrics.total_organic_results || 0}</div>
                        <div class="stat-label">Organic Results</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${metrics.high_authority_domains_in_top10 || 0}</div>
                        <div class="stat-label">High Auth Domains</div>
                    </div>
                </div>
                <p style="font-size: 13px; color: #515154; margin-top: 12px;">
                    <strong>Assessment:</strong> ${data.difficulty_level} difficulty means ${
                        data.difficulty_level === 'Easy' ? 'good opportunity for new entrants with proper SEO' :
                        data.difficulty_level === 'Medium' ? 'moderate competition, requires solid SEO strategy' :
                        'highly competitive, requires significant SEO investment'
                    }.
                </p>
            `;
        }

        function renderSerpFeatures(data) {
            const features = data.features || {};
            
            const featureList = [
                { key: 'has_ads', label: 'Paid Ads', count: features.num_ads },
                { key: 'has_local_results', label: 'Local Pack' },
                { key: 'has_featured_snippet', label: 'Featured Snippet' },
                { key: 'has_knowledge_graph', label: 'Knowledge Graph' },
                { key: 'has_people_also_ask', label: 'People Also Ask' },
                { key: 'has_related_searches', label: 'Related Searches' },
                { key: 'has_image_results', label: 'Images' },
                { key: 'has_video_results', label: 'Videos' },
                { key: 'has_shopping_results', label: 'Shopping' }
            ];

            let html = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">';
            
            featureList.forEach(feature => {
                const present = features[feature.key];
                const icon = present ? '‚úÖ' : '‚ùå';
                const color = present ? '#34c759' : '#d2d2d7';
                const count = feature.count ? ` (${feature.count})` : '';
                
                html += `
                    <div style="padding: 8px; background: ${present ? '#f0fdf4' : '#fafafa'}; border-radius: 6px; border: 1px solid ${color}; font-size: 12px;">
                        ${icon} ${feature.label}${count}
                    </div>
                `;
            });
            
            html += '</div>';
            
            html += `
                <p style="font-size: 13px; color: #515154; margin-top: 12px;">
                    <strong>Impact:</strong> ${features.has_local_results ? 'Local pack present - location-based visibility is critical.' : ''}
                    ${features.has_ads && features.num_ads > 0 ? ` ${features.num_ads} paid ads indicate commercial intent.` : ''}
                    ${features.has_people_also_ask ? ' FAQ content opportunities exist.' : ''}
                </p>
            `;

            return html;
        }

        async function loadVolumeAnalytics() {
            showLoading();
            currentView = 'volume';
            
            try {
                const [volumeHistory, comparison, regional] = await Promise.all([
                    fetch(`${API_BASE}/keyword-volume-history`).then(r => r.json()),
                    fetch(`${API_BASE}/keyword-comparison`).then(r => r.json()),
                    fetch(`${API_BASE}/regional-interest`).then(r => r.json())
                ]);

                hideLoading();

                let html = '';
                
                // Volume History with Chart
                html += renderVolumeSection(volumeHistory);
                
                // Keyword Comparison
                html += renderComparisonSection(comparison);
                
                // Regional Analysis
                html += renderRegionalSection(regional);

                document.getElementById('dataContainer').innerHTML = html;
                
            } catch (error) {
                hideLoading();
                document.getElementById('dataContainer').innerHTML = `
                    <div class="error-box">Error: ${error.message}</div>
                `;
            }
        }

        function renderVolumeSection(data) {
            if (data.status !== 'success') {
                return createSection('Volume History', '', `<div class="error-box">${data.error}</div>`);
            }

            const periods = data.historical_data || [];
            const comp = data.comparison?.recent_vs_older;
            
            let html = createSection(
                'üìà Search Volume History',
                `Google Trends data showing search interest over time. Interest scores are relative (0-100, where 100 is peak popularity). Data updated: ${new Date().toLocaleString()}`,
                `
                    <div class="chart-container">
                        <canvas id="volumeChart"></canvas>
                    </div>
                    <div class="stat-grid" style="margin-top: 16px;">
                        ${periods.map(p => {
                            const stats = p.statistics || {};
                            const trend = stats.trend === 'rising' ? 'üìà' : 'üìâ';
                            return `
                                <div class="stat-box">
                                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">${p.date_range}</div>
                                    <div style="font-size: 12px; color: #86868b;">
                                        Avg: ${stats.avg_interest?.toFixed(1)} ${trend}<br>
                                        Peak: ${stats.max_interest}, Low: ${stats.min_interest}<br>
                                        Points: ${p.data_points}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ${comp ? `
                        <div class="success-box" style="margin-top: 16px;">
                            <strong>Period Comparison:</strong> ${comp.direction === 'up' ? 'üìà Increasing' : 'üìâ Decreasing'} 
                            ${Math.abs(comp.change_percent).toFixed(1)}% (${comp.older_avg.toFixed(1)} ‚Üí ${comp.recent_avg.toFixed(1)})
                        </div>
                    ` : ''}
                `,
                data
            );

            setTimeout(() => renderVolumeChart(periods), 100);
            return html;
        }

        function renderVolumeChart(periods) {
            const canvas = document.getElementById('volumeChart');
            if (!canvas) return;

            const period = periods[0] || {};
            const timeline = period.timeline || [];
            
            const labels = timeline.map(p => p.date || '');
            const values = timeline.map(p => {
                const v = p.values || [];
                return v[0] ? v[0].extracted_value : 0;
            });

            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Search Interest (REAL GOOGLE TRENDS)',
                        data: values,
                        borderColor: '#007aff',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Interest Level (0-100)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: `Timeline - ${period.date_range} (${timeline.length} data points)`
                            },
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    }
                }
            });
        }

        function renderComparisonSection(data) {
            if (data.status !== 'success') {
                return createSection('Keyword Comparison', '', `<div class="error-box">${data.error}</div>`);
            }

            const ranking = data.ranking || [];
            
            return createSection(
                'üìä Multi-Keyword Performance Comparison',
                `Comparing ${ranking.length} related keywords over the last 3 months. Higher average interest indicates more search volume.`,
                `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Keyword</th>
                                <th>Avg Interest</th>
                                <th>Interpretation</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ranking.map((item, i) => {
                                const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1;
                                return `
                                    <tr>
                                        <td>${medal}</td>
                                        <td><strong>${item.keyword}</strong></td>
                                        <td class="rating">${item.avg_interest.toFixed(1)}</td>
                                        <td style="font-size: 12px; color: #86868b;">
                                            ${i === 0 ? 'Highest search volume - primary target' :
                                              i === 1 ? 'Strong secondary keyword' :
                                              i === 2 ? 'Good alternative keyword' :
                                              'Lower volume - niche opportunity'}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    <div class="chart-container" style="height: 250px; margin-top: 16px;">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                `,
                data
            );
        }

        function renderRegionalSection(data) {
            if (data.status !== 'success') {
                return createSection('Regional Analysis', '', `<div class="error-box">${data.error}</div>`);
            }

            const topRegions = data.top_regions || [];
            
            return createSection(
                'üó∫Ô∏è Geographic Interest Distribution',
                `Interest by US state for "moving companies" searches. DC, NY, and VA show highest demand. Florida ranks #4 nationally.`,
                `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>State</th>
                                <th>Interest Score</th>
                                <th>Market Potential</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${topRegions.slice(0, 15).map((region, i) => {
                                const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1;
                                const barWidth = (region.extracted_value / topRegions[0].extracted_value) * 100;
                                const potential = region.extracted_value > 70 ? 'Very High' :
                                                region.extracted_value > 50 ? 'High' :
                                                region.extracted_value > 30 ? 'Medium' : 'Lower';
                                
                                return `
                                    <tr>
                                        <td>${medal}</td>
                                        <td><strong>${region.location}</strong></td>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="flex: 1; background: #e5e5e7; height: 20px; border-radius: 4px; overflow: hidden;">
                                                    <div style="width: ${barWidth}%; background: #007aff; height: 100%;"></div>
                                                </div>
                                                <span style="font-weight: 600; min-width: 35px;">${region.extracted_value}</span>
                                            </div>
                                        </td>
                                        <td style="color: ${potential === 'Very High' ? '#34c759' : potential === 'High' ? '#007aff' : '#86868b'};">
                                            ${potential}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `,
                data
            );
        }

        async function loadKeywordResearch() {
            showLoading();
            currentView = 'keywords';
            
            try {
                const [suggestions, autocomplete, related, paa] = await Promise.all([
                    fetch(`${API_BASE}/keyword-suggestions`).then(r => r.json()),
                    fetch(`${API_BASE}/autocomplete`).then(r => r.json()),
                    fetch(`${API_BASE}/related-searches`).then(r => r.json()),
                    fetch(`${API_BASE}/people-also-ask`).then(r => r.json())
                ]);

                hideLoading();

                let html = '';
                
                html += createSection(
                    'üí° Keyword Suggestions',
                    `${suggestions.total_suggestions} keyword ideas based on autocomplete data. These show actual user search patterns.`,
                    `<div>${suggestions.suggestions.map(kw => `<span class="keyword-pill">${kw}</span>`).join('')}</div>`,
                    suggestions
                );

                html += createSection(
                    'üîó Related Searches',
                    `${related.total_related} related queries that users are searching for. Use these for content strategy and PPC campaigns.`,
                    `<div>${related.related_searches.map(s => `<span class="keyword-pill">${s.query}</span>`).join('')}</div>`,
                    related
                );

                html += createSection(
                    '‚ùì People Also Ask',
                    `${paa.total_questions} questions users commonly search for. Create content answering these to capture featured snippets.`,
                    `
                        <table class="table">
                            <thead><tr><th>#</th><th>Question</th><th>Answer Preview</th></tr></thead>
                            <tbody>
                                ${paa.questions.map((q, i) => `
                                    <tr>
                                        <td>${i + 1}</td>
                                        <td><strong>${q.question}</strong></td>
                                        <td style="font-size: 12px; color: #86868b;">${q.answer ? q.answer.substring(0, 100) + '...' : 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `,
                    paa
                );

                document.getElementById('dataContainer').innerHTML = html;
                
            } catch (error) {
                hideLoading();
                document.getElementById('dataContainer').innerHTML = `<div class="error-box">Error: ${error.message}</div>`;
            }
        }

        async function loadCompetitorIntel() {
            showLoading();
            currentView = 'competitors';
            
            try {
                const [yelp, youtube, jobs, search] = await Promise.all([
                    fetch(`${API_BASE}/yelp-businesses`).then(r => r.json()),
                    fetch(`${API_BASE}/youtube-videos`).then(r => r.json()),
                    fetch(`${API_BASE}/job-listings`).then(r => r.json()),
                    fetch(`${API_BASE}/google-search`).then(r => r.json())
                ]);

                hideLoading();

                let html = '';
                
                html += renderYelpSection(yelp);
                html += renderSearchResults(search);
                html += renderJobsSection(jobs);
                html += renderYouTubeSection(youtube);

                document.getElementById('dataContainer').innerHTML = html;
                
            } catch (error) {
                hideLoading();
                document.getElementById('dataContainer').innerHTML = `<div class="error-box">Error: ${error.message}</div>`;
            }
        }

        function renderYelpSection(data) {
            if (data.status !== 'success') {
                return createSection('Yelp Reviews', '', `<div class="error-box">${data.error}</div>`);
            }

            const avgRating = data.businesses ? 
                (data.businesses.reduce((sum, b) => sum + (b.rating || 0), 0) / data.businesses.length).toFixed(1) : 0;

            return createSection(
                '‚≠ê Yelp Business Intelligence',
                `${data.total_results} moving companies on Yelp with average ${avgRating}‚òÖ rating. Review analysis helps identify competitor strengths/weaknesses.`,
                `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Business</th>
                                <th>Rating</th>
                                <th>Reviews</th>
                                <th>Price</th>
                                <th>Categories</th>
                                <th>Phone</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.businesses.map((biz, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td><strong>${biz.business_name}</strong></td>
                                    <td class="rating">‚≠ê ${biz.rating || 'N/A'}</td>
                                    <td>${(biz.reviews_count || 0).toLocaleString()}</td>
                                    <td>${biz.price_range || 'N/A'}</td>
                                    <td style="font-size: 11px;">${biz.categories ? biz.categories.slice(0, 2).join(', ') : 'N/A'}</td>
                                    <td>${biz.phone || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `,
                data
            );
        }

        function renderSearchResults(data) {
            if (data.status !== 'success') {
                return createSection('Google Search', '', `<div class="error-box">${data.error}</div>`);
            }

            return createSection(
                'üîç Organic Search Results',
                `Top ${data.total_results} organic results for "moving companies miami". Position 1-3 get 60%+ of clicks.`,
                `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Title</th>
                                <th>Domain</th>
                                <th>Snippet</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.organic_results.map(result => `
                                <tr>
                                    <td><strong>${result.position}</strong></td>
                                    <td>${result.title}</td>
                                    <td style="font-size: 11px; color: #007aff;">${result.displayed_link || 'N/A'}</td>
                                    <td style="font-size: 12px; color: #86868b;">${result.snippet.substring(0, 80)}...</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `,
                data
            );
        }

        function renderJobsSection(data) {
            if (data.status !== 'success') {
                return createSection('Job Market', '', `<div class="error-box">${data.error}</div>`);
            }

            return createSection(
                'üíº Job Market Intelligence',
                `${data.total_results} mover job listings in Miami. Salary data reveals competitive compensation and hiring demand.`,
                `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th>Company</th>
                                <th>Salary</th>
                                <th>Type</th>
                                <th>Posted</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.jobs.map(job => `
                                <tr>
                                    <td><strong>${job.job_title}</strong></td>
                                    <td>${job.company_name}</td>
                                    <td style="color: #34c759; font-weight: 600;">${job.salary || 'Not disclosed'}</td>
                                    <td>${job.schedule_type || 'N/A'}</td>
                                    <td style="font-size: 12px;">${job.posted_at || 'Recently'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `,
                data
            );
        }

        function renderYouTubeSection(data) {
            if (data.status !== 'success') {
                return createSection('YouTube', '', `<div class="error-box">${data.error}</div>`);
            }

            return createSection(
                'üé• YouTube Video Content',
                `${data.total_results} videos about Miami moving companies. View counts indicate content popularity and potential virality.`,
                `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Channel</th>
                                <th>Views</th>
                                <th>Duration</th>
                                <th>Published</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.videos.map(video => `
                                <tr>
                                    <td><strong>${video.title}</strong></td>
                                    <td>${video.channel_name}</td>
                                    <td class="rating">${video.views}</td>
                                    <td>${video.duration || 'N/A'}</td>
                                    <td style="font-size: 12px;">${video.published_date || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `,
                data
            );
        }

        async function loadMediaAnalysis() {
            showLoading();
            currentView = 'media';
            
            try {
                const [images, news, shopping, walmart] = await Promise.all([
                    fetch(`${API_BASE}/image-search`).then(r => r.json()),
                    fetch(`${API_BASE}/news-search`).then(r => r.json()),
                    fetch(`${API_BASE}/shopping-search`).then(r => r.json()),
                    fetch(`${API_BASE}/walmart-products`).then(r => r.json())
                ]);

                hideLoading();

                let html = '';
                
                html += renderNewsSection(news);
                html += renderProductsComparison(shopping, walmart);
                html += renderImageSection(images);

                document.getElementById('dataContainer').innerHTML = html;
                
            } catch (error) {
                hideLoading();
                document.getElementById('dataContainer').innerHTML = `<div class="error-box">Error: ${error.message}</div>`;
            }
        }

        function renderNewsSection(data) {
            if (data.status !== 'success') {
                return createSection('News', '', `<div class="error-box">${data.error}</div>`);
            }

            return createSection(
                'üì∞ Industry News & Updates',
                `${data.total_results} recent articles from the past month. Track industry trends and competitor announcements.`,
                `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Headline</th>
                                <th>Source</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.news.map(article => `
                                <tr>
                                    <td style="font-size: 12px; white-space: nowrap;">${article.date || 'Recent'}</td>
                                    <td><strong>${article.title}</strong></td>
                                    <td style="font-size: 12px;">${article.source}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `,
                data
            );
        }

        function renderProductsComparison(shopping, walmart) {
            const allProducts = [
                ...(shopping.products || []).map(p => ({...p, source_type: 'Google Shopping'})),
                ...(walmart.products || []).map(p => ({...p, source_type: 'Walmart', product_name: p.product_name || p.title}))
            ];

            // Calculate price statistics
            const prices = allProducts.map(p => p.extracted_price || parseFloat(p.price) || 0).filter(p => p > 0);
            const avgPrice = prices.length > 0 ? (prices.reduce((a, b) => a + b, 0) / prices.length).toFixed(2) : 0;
            const minPrice = prices.length > 0 ? Math.min(...prices).toFixed(2) : 0;
            const maxPrice = prices.length > 0 ? Math.max(...prices).toFixed(2) : 0;

            return createSection(
                'üõí Moving Supplies - Price Intelligence',
                `${allProducts.length} products analyzed from multiple retailers. Price range: $${minPrice} - $${maxPrice}, Average: $${avgPrice}`,
                `
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-number">${allProducts.length}</div>
                            <div class="stat-label">Products Tracked</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">$${minPrice}</div>
                            <div class="stat-label">Lowest Price</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">$${avgPrice}</div>
                            <div class="stat-label">Average Price</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">$${maxPrice}</div>
                            <div class="stat-label">Highest Price</div>
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Price</th>
                                <th>Rating</th>
                                <th>Reviews</th>
                                <th>Retailer</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allProducts.slice(0, 20).map(p => `
                                <tr>
                                    <td>${p.product_name || p.title}</td>
                                    <td style="font-weight: 600;">$${p.extracted_price || p.price || 'N/A'}</td>
                                    <td class="rating">${p.rating ? `‚≠ê ${p.rating}` : 'N/A'}</td>
                                    <td>${p.reviews || p.reviews_count || 0}</td>
                                    <td style="font-size: 11px;">${p.source_type || p.source || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `
            );
        }

        function renderImageSection(data) {
            if (data.status !== 'success') {
                return createSection('Images', '', `<div class="error-box">${data.error}</div>`);
            }

            return createSection(
                'üñºÔ∏è Visual Content Analysis',
                `${data.total_images} images found. Analyze competitor branding, truck designs, and marketing materials.`,
                `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px;">
                        ${data.images.slice(0, 20).map(img => `
                            <div style="position: relative;">
                                <img src="${img.thumbnail}" alt="${img.title}" 
                                     style="width: 100%; height: 100px; object-fit: cover; border-radius: 6px;" 
                                     title="${img.title}">
                                <div style="font-size: 10px; margin-top: 4px; color: #86868b;">${img.source || 'N/A'}</div>
                            </div>
                        `).join('')}
                    </div>
                `,
                data
            );
        }

        async function loadAllDetailed() {
            showLoading();
            
            try {
                // Load ALL 16 main APIs in parallel (COMPLETE DATA VIEW)
                const [
                    search, local, difficulty, serp,
                    keywords, related, paa, autocomplete,
                    yelp, youtube, jobs,
                    news, images, shopping, walmart,
                    volumeHistory
                ] = await Promise.all([
                    fetch(`${API_BASE}/google-search`).then(r => r.json()),
                    fetch(`${API_BASE}/local-businesses`).then(r => r.json()),
                    fetch(`${API_BASE}/keyword-difficulty`).then(r => r.json()),
                    fetch(`${API_BASE}/serp-analysis`).then(r => r.json()),
                    fetch(`${API_BASE}/keyword-suggestions`).then(r => r.json()),
                    fetch(`${API_BASE}/related-searches`).then(r => r.json()),
                    fetch(`${API_BASE}/people-also-ask`).then(r => r.json()),
                    fetch(`${API_BASE}/autocomplete`).then(r => r.json()),
                    fetch(`${API_BASE}/yelp-businesses`).then(r => r.json()),
                    fetch(`${API_BASE}/youtube-videos`).then(r => r.json()),
                    fetch(`${API_BASE}/job-listings`).then(r => r.json()),
                    fetch(`${API_BASE}/news-search`).then(r => r.json()),
                    fetch(`${API_BASE}/image-search`).then(r => r.json()),
                    fetch(`${API_BASE}/shopping-search`).then(r => r.json()),
                    fetch(`${API_BASE}/walmart-products`).then(r => r.json()),
                    fetch(`${API_BASE}/keyword-volume-history`).then(r => r.json())
                ]);

                hideLoading();

                const totalDataPoints = 
                    (local.total_results || 0) +
                    (keywords.total_suggestions || 0) +
                    (related.total_related || 0) +
                    (paa.total_questions || 0) +
                    (yelp.total_results || 0) +
                    (youtube.total_results || 0) +
                    (jobs.total_results || 0) +
                    (images.total_images || 0) +
                    (news.total_results || 0) +
                    (shopping.total_results || 0) +
                    (walmart.total_results || 0);

                let html = `
                    <div class="section" style="background: linear-gradient(135deg, #34c759 0%, #30b350 100%); color: white;">
                        <h2 style="margin: 0 0 12px 0;">‚úÖ COMPLETE DATA VIEW - All 16 APIs Loaded</h2>
                        <div class="stat-grid">
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">${totalDataPoints}</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Total Data Points</div>
                            </div>
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">16</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">APIs Active</div>
                            </div>
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">${volumeHistory.periods_analyzed || 0}</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Time Periods</div>
                            </div>
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">100%</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Real Data</div>
                            </div>
                        </div>
                        <p style="margin-top: 12px; font-size: 13px; opacity: 0.9;">
                            Last loaded: ${new Date().toLocaleString()} | 
                            Database: 1,275+ records | 
                            Cache: 15min TTL | 
                            Status: All operational
                        </p>
                    </div>
                `;

                // All sections
                html += createSection('üè¢ Google Maps Businesses', `20 movers. DB saved. ${getTimestamp(local)}`, renderLocalTable(local), local);
                html += createSection('‚≠ê Yelp Reviews', `10 businesses. DB saved. ${getTimestamp(yelp)}`, renderYelpTable(yelp), yelp);
                html += createSection('üîç Google Search Results', `Top 9. DB saved. ${getTimestamp(search)}`, renderSearchResults(search), search);
                html += createSection('üíº Job Listings', `10 positions. ${getTimestamp(jobs)}`, renderJobsSection(jobs), jobs);
                html += createSection('üé• YouTube Videos', `10 videos. ${getTimestamp(youtube)}`, renderYouTubeSection(youtube), youtube);
                html += createSection('üéØ Keyword Difficulty', `Score: 7/100. ${getTimestamp(difficulty)}`, renderDifficultyCompact(difficulty), difficulty);
                html += createSection('üìä SERP Features', `${getTimestamp(serp)}`, renderSerpFeatures(serp), serp);
                html += createSection('üí° Keyword Suggestions', `${keywords.total_suggestions} ideas. ${getTimestamp(keywords)}`, `<div>${keywords.suggestions.map(kw => `<span class="keyword-pill">${kw}</span>`).join('')}</div>`, keywords);
                html += createSection('üîó Related Searches', `${related.total_related} queries. ${getTimestamp(related)}`, `<div>${related.related_searches.map(s => `<span class="keyword-pill">${s.query}</span>`).join('')}</div>`, related);
                html += createSection('‚ùì People Also Ask', `${paa.total_questions} FAQs. ${getTimestamp(paa)}`, renderPAATable(paa), paa);
                html += createSection('üì∞ News Articles', `${news.total_results} articles. ${getTimestamp(news)}`, renderNewsTable(news), news);
                html += createSection('üõí Shopping Products', `${shopping.total_results} items. ${getTimestamp(shopping)}`, renderProductsTable(shopping), shopping);
                html += createSection('üè™ Walmart Products', `${walmart.total_results} items. ${getTimestamp(walmart)}`, renderProductsTable(walmart), walmart);
                html += createSection('üñºÔ∏è Images', `${images.total_images} images. ${getTimestamp(images)}`, renderImagesCompact(images), images);
                html += createSection('üìà Volume History', `${volumeHistory.periods_analyzed} periods tracked`, renderVolumeStats(volumeHistory), volumeHistory);

                document.getElementById('dataContainer').innerHTML = html;
                
            } catch (error) {
                hideLoading();
                document.getElementById('dataContainer').innerHTML = `<div class="error-box">Error: ${error.message}</div>`;
            }
        }

        function renderProductsTable(data) {
            if (!data.products || data.products.length === 0) {
                return '<p style="color: #86868b;">No products available</p>';
            }

            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Rating</th>
                            <th>Retailer</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.products.slice(0, 15).forEach(p => {
                const productName = p.product_name || p.title;
                const price = p.extracted_price || p.price || 'N/A';
                html += `
                    <tr>
                        <td>${productName}</td>
                        <td style="font-weight: 600;">$${price}</td>
                        <td class="rating">${p.rating ? `‚≠ê ${p.rating}` : 'N/A'}</td>
                        <td style="font-size: 12px;">${p.source || 'N/A'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            html += `<p style="font-size: 12px; color: #86868b; margin-top: 8px;">Showing 15 of ${data.total_results} products. Full data in database.</p>`;
            return html;
        }

        function renderVolumeStats(data) {
            if (data.status !== 'success' || !data.historical_data) {
                return '<p style="color: #86868b;">No volume data available</p>';
            }

            const periods = data.historical_data;
            let html = '<div class="stat-grid">';
            
            periods.forEach(p => {
                const stats = p.statistics || {};
                html += `
                    <div class="stat-box">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">${p.date_range}</div>
                        <div style="font-size: 12px; color: #86868b;">
                            Avg: ${stats.avg_interest?.toFixed(1)} ${stats.trend === 'rising' ? 'üìà' : 'üìâ'}<br>
                            Peak: ${stats.max_interest}, Low: ${stats.min_interest}<br>
                            Data points: ${p.data_points} (saved to DB)
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (data.comparison?.recent_vs_older) {
                const comp = data.comparison.recent_vs_older;
                html += `
                    <div class="success-box" style="margin-top: 12px;">
                        <strong>Trend Analysis:</strong> ${comp.direction === 'up' ? 'üìà Growing' : 'üìâ Declining'} 
                        ${Math.abs(comp.change_percent).toFixed(1)}% over time (${comp.older_avg.toFixed(1)} ‚Üí ${comp.recent_avg.toFixed(1)})
                    </div>
                `;
            }

            return html;
        }

        async function loadKeywordData() {
            const [suggestions, related] = await Promise.all([
                fetch(`${API_BASE}/keyword-suggestions`).then(r => r.json()),
                fetch(`${API_BASE}/related-searches`).then(r => r.json())
            ]);

            return createSection(
                'üí° Keyword Research',
                `${suggestions.total_suggestions + related.total_related} total keyword opportunities identified.`,
                `
                    <strong>Suggestions:</strong><br>
                    ${suggestions.suggestions.slice(0, 15).map(kw => `<span class="keyword-pill">${kw}</span>`).join('')}
                    <br><br>
                    <strong>Related Searches:</strong><br>
                    ${related.related_searches.map(s => `<span class="keyword-pill">${s.query}</span>`).join('')}
                `
            );
        }

        async function loadMediaData() {
            const [news, images] = await Promise.all([
                fetch(`${API_BASE}/news-search`).then(r => r.json()),
                fetch(`${API_BASE}/image-search`).then(r => r.json())
            ]);

            return createSection(
                'üì∞ Media & Content',
                `${news.total_results} news articles, ${images.total_images} images tracked.`,
                `
                    <strong>Recent News:</strong>
                    <ul style="margin: 12px 0; padding-left: 20px; font-size: 13px;">
                        ${news.news.map(article => `
                            <li>${article.title} <span style="color: #86868b;">(${article.source}, ${article.date})</span></li>
                        `).join('')}
                    </ul>
                `
            );
        }

        async function forceRefreshAll() {
            if (confirm('Force refresh will make new API calls for all data. This may take 30-60 seconds. Continue?')) {
                showLoading();
                
                const refreshParam = '?refresh=true';
                
                try {
                    const [search, local] = await Promise.all([
                        fetch(`${API_BASE}/google-search${refreshParam}`).then(r => r.json()),
                        fetch(`${API_BASE}/local-businesses${refreshParam}`).then(r => r.json())
                    ]);

                    // Reload current view
                    if (currentView === 'overview') loadOverview();
                    else if (currentView === 'volume') loadVolumeAnalytics();
                    else if (currentView === 'competitors') loadCompetitorIntel();
                    else loadOverview();
                    
                } catch (error) {
                    hideLoading();
                    alert('Error during refresh: ' + error.message);
                }
            }
        }

        // Complete Intelligence View - ALL APIs with diagrams
        async function loadCompleteIntelligence() {
            showLoading();
            currentView = 'complete';
            
            try {
                // Load ALL 25+ APIs in parallel
                const [
                    search, local, difficulty, serp,
                    keywords, related, paa, autocomplete,
                    yelp, youtube, jobs, tripadvisor,
                    news, images, shopping, walmart,
                    amazon, apple, googleplay, patents,
                    volumeHistory, regional, comparison
                ] = await Promise.all([
                    fetch(`${API_BASE}/google-search`).then(r => r.json()),
                    fetch(`${API_BASE}/local-businesses`).then(r => r.json()),
                    fetch(`${API_BASE}/keyword-difficulty`).then(r => r.json()),
                    fetch(`${API_BASE}/serp-analysis`).then(r => r.json()),
                    fetch(`${API_BASE}/keyword-suggestions`).then(r => r.json()),
                    fetch(`${API_BASE}/related-searches`).then(r => r.json()),
                    fetch(`${API_BASE}/people-also-ask`).then(r => r.json()),
                    fetch(`${API_BASE}/autocomplete`).then(r => r.json()),
                    fetch(`${API_BASE}/yelp-businesses`).then(r => r.json()),
                    fetch(`${API_BASE}/youtube-videos`).then(r => r.json()),
                    fetch(`${API_BASE}/job-listings`).then(r => r.json()),
                    fetch(`${API_BASE}/tripadvisor`).then(r => r.json()),
                    fetch(`${API_BASE}/news-search`).then(r => r.json()),
                    fetch(`${API_BASE}/image-search`).then(r => r.json()),
                    fetch(`${API_BASE}/shopping-search`).then(r => r.json()),
                    fetch(`${API_BASE}/walmart-products`).then(r => r.json()),
                    fetch(`${API_BASE}/amazon-products`).then(r => r.json()),
                    fetch(`${API_BASE}/apple-apps`).then(r => r.json()),
                    fetch(`${API_BASE}/google-play-apps`).then(r => r.json()),
                    fetch(`${API_BASE}/patents`).then(r => r.json()),
                    fetch(`${API_BASE}/keyword-volume-history`).then(r => r.json()),
                    fetch(`${API_BASE}/regional-interest`).then(r => r.json()),
                    fetch(`${API_BASE}/keyword-comparison`).then(r => r.json())
                ]);

                hideLoading();

                const totalDataPoints = 
                    (local.total_results || 0) +
                    (keywords.total_suggestions || 0) +
                    (related.total_related || 0) +
                    (paa.total_questions || 0) +
                    (yelp.total_results || 0) +
                    (youtube.total_results || 0) +
                    (jobs.total_results || 0) +
                    (images.total_images || 0) +
                    (news.total_results || 0) +
                    (shopping.total_results || 0) +
                    (walmart.total_results || 0) +
                    (amazon.total_results || 0) +
                    (apple.total_results || 0) +
                    (googleplay.total_results || 0) +
                    (patents.total_results || 0);

                let html = `
                    <div class="section" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
                        <h2 style="margin: 0 0 12px 0;">üß† COMPLETE MARKET INTELLIGENCE - All 25+ APIs</h2>
                        <div class="stat-grid">
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">${totalDataPoints}</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Total Data Points</div>
                            </div>
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">25+</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">APIs Integrated</div>
                            </div>
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">1,275+</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">DB Records</div>
                            </div>
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">100%</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Real Data</div>
                            </div>
                        </div>
                        <p style="margin-top: 12px; font-size: 13px; opacity: 0.9;">
                            Last loaded: ${new Date().toLocaleString()} | 
                            Database: 1,275+ records | 
                            Cache: 15min TTL | 
                            Status: All operational
                        </p>
                    </div>
                `;

                // All sections with comprehensive data
                html += createSection('üè¢ Business Intelligence (20 Companies)', `Complete profiles with ratings, reviews, contact info. DB saved. ${getTimestamp(local)}`, renderLocalTable(local), local);
                html += createSection('‚≠ê Yelp Reviews (10 Businesses)', `Competitor analysis. DB saved. ${getTimestamp(yelp)}`, renderYelpTable(yelp), yelp);
                html += createSection('üîç Google Search Results (Top 9)', `Organic rankings. DB saved. ${getTimestamp(search)}`, renderSearchResults(search), search);
                html += createSection('üíº Job Market (10 Positions)', `Salary data & hiring trends. ${getTimestamp(jobs)}`, renderJobsSection(jobs), jobs);
                html += createSection('üé• YouTube Content (10 Videos)', `Video marketing analysis. ${getTimestamp(youtube)}`, renderYouTubeSection(youtube), youtube);
                html += createSection('üéØ Keyword Difficulty (7/100 Easy)', `SEO opportunity analysis. ${getTimestamp(difficulty)}`, renderDifficultyCompact(difficulty), difficulty);
                html += createSection('üìä SERP Features', `What appears in Google results. ${getTimestamp(serp)}`, renderSerpFeatures(serp), serp);
                html += createSection('üí° Keyword Suggestions (15 ideas)', `Autocomplete-based suggestions. ${getTimestamp(keywords)}`, `<div>${keywords.suggestions.map(kw => `<span class="keyword-pill">${kw}</span>`).join('')}</div>`, keywords);
                html += createSection('üîó Related Searches (8 queries)', `User search patterns. ${getTimestamp(related)}`, `<div>${related.related_searches.map(s => `<span class="keyword-pill">${s.query}</span>`).join('')}</div>`, related);
                html += createSection('‚ùì People Also Ask (4 FAQs)', `Content opportunities. ${getTimestamp(paa)}`, renderPAATable(paa), paa);
                html += createSection('üì∞ News Articles (5 recent)', `Industry trends. ${getTimestamp(news)}`, renderNewsTable(news), news);
                html += createSection('üõí Shopping Products (40 items)', `Supply pricing. ${getTimestamp(shopping)}`, renderProductsTable(shopping), shopping);
                html += createSection('üè™ Walmart Products', `Retail pricing. ${getTimestamp(walmart)}`, renderProductsTable(walmart), walmart);
                html += createSection('üõçÔ∏è Amazon Products', `E-commerce analysis. ${getTimestamp(amazon)}`, renderProductsTable(amazon), amazon);
                html += createSection('üì± Apple App Store', `Mobile apps. ${getTimestamp(apple)}`, renderAppStoreTable(apple), apple);
                html += createSection('üì± Google Play Store', `Android apps. ${getTimestamp(googleplay)}`, renderAppStoreTable(googleplay), googleplay);
                html += createSection('üî¨ Patents', `Innovation tracking. ${getTimestamp(patents)}`, renderPatentsTable(patents), patents);
                html += createSection('üñºÔ∏è Images (100 total)', `Visual content. ${getTimestamp(images)}`, renderImagesCompact(images), images);
                html += createSection('üìà Volume History', `${volumeHistory.periods_analyzed} periods tracked`, renderVolumeStats(volumeHistory), volumeHistory);
                html += createSection('üó∫Ô∏è Regional Interest', `51 states analyzed`, renderRegionalStats(regional), regional);

                document.getElementById('dataContainer').innerHTML = html;
                
            } catch (error) {
                hideLoading();
                document.getElementById('dataContainer').innerHTML = `<div class="error-box">Error: ${error.message}</div>`;
            }
        }

        function renderAppStoreTable(data) {
            if (!data.apps || data.apps.length === 0) {
                return '<p style="color: #86868b;">No apps available</p>';
            }

            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>App Name</th>
                            <th>Rating</th>
                            <th>Reviews</th>
                            <th>Price</th>
                            <th>Developer</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.apps.slice(0, 10).forEach(app => {
                html += `
                    <tr>
                        <td><strong>${app.app_name || app.title}</strong></td>
                        <td class="rating">${app.rating ? `‚≠ê ${app.rating}` : 'N/A'}</td>
                        <td>${(app.reviews_count || 0).toLocaleString()}</td>
                        <td>${app.price || 'Free'}</td>
                        <td style="font-size: 12px;">${app.developer || 'N/A'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            html += `<p style="font-size: 12px; color: #86868b; margin-top: 8px;">Showing 10 of ${data.total_results} apps. Full data in database.</p>`;
            return html;
        }

        function renderPatentsTable(data) {
            if (!data.patents || data.patents.length === 0) {
                return '<p style="color: #86868b;">No patents available</p>';
            }

            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Patent Title</th>
                            <th>Inventor</th>
                            <th>Date</th>
                            <th>Patent Number</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.patents.slice(0, 10).forEach(patent => {
                html += `
                    <tr>
                        <td><strong>${patent.title}</strong></td>
                        <td style="font-size: 12px;">${patent.inventor || 'N/A'}</td>
                        <td style="font-size: 12px;">${patent.date || 'N/A'}</td>
                        <td style="font-size: 12px;">${patent.patent_number || 'N/A'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            html += `<p style="font-size: 12px; color: #86868b; margin-top: 8px;">Showing 10 of ${data.total_results} patents. Full data in database.</p>`;
            return html;
        }

        function renderRegionalStats(data) {
            if (!data.regions || data.regions.length === 0) {
                return '<p style="color: #86868b;">No regional data available</p>';
            }

            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>State</th>
                            <th>Interest</th>
                            <th>Market Potential</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.regions.slice(0, 15).forEach((region, i) => {
                const potential = region.interest_value >= 80 ? 'Very High' : 
                                region.interest_value >= 60 ? 'High' : 
                                region.interest_value >= 40 ? 'Medium' : 'Low';
                
                html += `
                    <tr>
                        <td>${i + 1}</td>
                        <td><strong>${region.region}</strong></td>
                        <td style="font-weight: 600;">${region.interest_value}</td>
                        <td style="font-size: 12px; color: ${region.interest_value >= 60 ? '#10b981' : '#86868b'};">${potential}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            html += `<p style="font-size: 12px; color: #86868b; margin-top: 8px;">Showing top 15 of ${data.total_regions} states. All 51 states tracked in database.</p>`;
            return html;
        }

        // Miami Map View - Geographic visualization with Mapbox
        async function loadMiamiMap() {
            showLoading();
            currentView = 'miami-map';
            
            try {
                const response = await fetch('/api/miami-map-data');
                const mapData = await response.json();
                
                hideLoading();
                
                let html = `
                    <div class="header-section">
                        <h1>üó∫Ô∏è Miami Market Intelligence Map</h1>
                        <p>Geographic visualization of all SerpApi data with interactive maps, heatmaps, and market analysis</p>
                    </div>
                `;
                
                if (mapData.status === 'success') {
                    const data = mapData.data;
                    
                    // Map Overview Stats
                    html += createSection(
                        'üìç Map Overview',
                        'Geographic distribution of Miami moving companies and market intelligence',
                        renderMapOverview(data),
                        { from_cache: false, age_minutes: 0, response_time_ms: 0, saved_to_db: true }
                    );
                    
                    // Business Locations
                    if (data.business_locations?.features) {
                        html += createSection(
                            `üè¢ Business Locations (${data.business_locations.total_businesses} found)`,
                            'Interactive map showing all moving companies with ratings, reviews, and contact info',
                            renderBusinessLocations(data.business_locations),
                            { from_cache: false, age_minutes: 0, response_time_ms: 0, saved_to_db: true }
                        );
                    }
                    
                    // Rating Heatmap
                    if (data.rating_heatmap?.heatmap_data) {
                        html += createSection(
                            `üî• Rating Heatmap (${data.rating_heatmap.total_points} points)`,
                            'Heatmap visualization showing business density and rating intensity across Miami',
                            renderRatingHeatmap(data.rating_heatmap),
                            { from_cache: false, age_minutes: 0, response_time_ms: 0, saved_to_db: true }
                        );
                    }
                    
                    // Market Density Analysis
                    if (data.market_density?.area_analysis) {
                        html += createSection(
                            `üìä Market Density Analysis (${data.market_density.total_areas} areas)`,
                            'Analysis of business density and competition in different Miami neighborhoods',
                            renderMarketDensity(data.market_density),
                            { from_cache: false, age_minutes: 0, response_time_ms: 0, saved_to_db: true }
                        );
                    }
                    
                    // Competitor Clusters
                    if (data.competitor_clusters?.clusters) {
                        html += createSection(
                            `üéØ Competitor Clusters (${data.competitor_clusters.total_clusters} clusters)`,
                            'Identified clusters of competing businesses in Miami market',
                            renderCompetitorClusters(data.competitor_clusters),
                            { from_cache: false, age_minutes: 0, response_time_ms: 0, saved_to_db: true }
                        );
                    }
                    
                    // Regional Interest
                    if (data.regional_interest?.features) {
                        html += createSection(
                            `üåé Regional Interest (${data.regional_interest.total_regions} states)`,
                            'Geographic distribution of search interest across different states',
                            renderRegionalInterestMap(data.regional_interest),
                            { from_cache: false, age_minutes: 0, response_time_ms: 0, saved_to_db: true }
                        );
                    }
                    
                    // Interactive Map Embed
                    // Store the map ID globally so we can initialize it after rendering
                    window.currentMapId = 'miami-map-' + Date.now();
                    
                    html += createSection(
                        'üó∫Ô∏è Interactive Map',
                        'Full-featured Mapbox visualization with all data layers and controls',
                        renderInteractiveMapWithId(mapData, window.currentMapId),
                        { from_cache: false, age_minutes: 0, response_time_ms: 0, saved_to_db: true }
                    );
                    
                } else {
                    html += `<div class="error-box">Error loading map data: ${mapData.error}</div>`;
                }
                
                document.getElementById('dataContainer').innerHTML = html;
                
                // Initialize the map after DOM is updated
                if (mapData.status === 'success' && window.currentMapId) {
                    setTimeout(() => initializeMiamiMap(window.currentMapId, mapData), 100);
                }
                
            } catch (error) {
                hideLoading();
                document.getElementById('dataContainer').innerHTML = `
                    <div class="error-box">Error: ${error.message}</div>
                `;
            }
        }

        // Miami Map Rendering Functions
        function renderMapOverview(data) {
            const businesses = data.business_locations?.features || [];
            const clusters = data.competitor_clusters?.clusters || [];
            const heatmapPoints = data.rating_heatmap?.heatmap_data || [];
            const regions = data.regional_interest?.features || [];
            
            let totalReviews = 0;
            let totalRating = 0;
            let ratingCount = 0;
            
            businesses.forEach(business => {
                if (business.properties.reviews) totalReviews += business.properties.reviews;
                if (business.properties.rating) {
                    totalRating += business.properties.rating;
                    ratingCount++;
                }
            });
            
            const avgRating = ratingCount > 0 ? (totalRating / ratingCount).toFixed(1) : 'N/A';
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 8px;">${businesses.length}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Business Locations</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 8px;">${avgRating}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Average Rating</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 8px;">${totalReviews.toLocaleString()}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Total Reviews</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 8px;">${clusters.length}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Market Clusters</div>
                    </div>
                </div>
                <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <strong>üó∫Ô∏è Map Features:</strong>
                    <ul style="margin: 8px 0 0 20px; color: #374151;">
                        <li><strong>Interactive Business Map:</strong> Click on any business marker to see details</li>
                        <li><strong>Rating Heatmap:</strong> Visual density of high-rated businesses</li>
                        <li><strong>Market Clusters:</strong> Identified competitor groupings</li>
                        <li><strong>Regional Analysis:</strong> Search interest across different states</li>
                        <li><strong>Neighborhood Analysis:</strong> Market density in Miami areas</li>
                    </ul>
                </div>
            `;
        }

        function renderBusinessLocations(data) {
            const features = data.features || [];
            const topBusinesses = features.slice(0, 10);
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: #374151; margin-bottom: 12px;">üìç Top 10 Businesses by Reviews</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            topBusinesses.forEach((business, index) => {
                const rating = business.properties.rating || 0;
                const reviews = business.properties.reviews || 0;
                const ratingColor = rating >= 4.5 ? '#10b981' : rating >= 4.0 ? '#f59e0b' : rating >= 3.5 ? '#f97316' : '#ef4444';
                
                html += `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <strong style="color: #1f2937;">${index + 1}. ${business.properties.name}</strong>
                            <span style="background: ${ratingColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                ‚≠ê ${rating}
                            </span>
                        </div>
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">
                            üìç ${business.properties.address || 'Address not available'}
                        </div>
                        <div style="font-size: 12px; color: #6b7280;">
                            üìû ${business.properties.phone || 'Phone not available'} | 
                            üí¨ ${reviews} reviews
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #374151; margin-bottom: 12px;">üó∫Ô∏è Map Legend</h4>
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <div style="width: 12px; height: 12px; background: #10b981; border-radius: 50%; margin-right: 8px;"></div>
                                    <span style="font-size: 14px;">High Rating (4.5+)</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 50%; margin-right: 8px;"></div>
                                    <span style="font-size: 14px;">Good Rating (4.0-4.4)</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <div style="width: 12px; height: 12px; background: #f97316; border-radius: 50%; margin-right: 8px;"></div>
                                    <span style="font-size: 14px;">Average Rating (3.5-3.9)</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 50%; margin-right: 8px;"></div>
                                    <span style="font-size: 14px;">Low Rating (Below 3.5)</span>
                                </div>
                            </div>
                            <div style="border-top: 1px solid #e5e7eb; padding-top: 12px;">
                                <div style="font-size: 12px; color: #6b7280;">
                                    <strong>Marker Size:</strong> Based on review count<br>
                                    <strong>Click:</strong> View business details<br>
                                    <strong>Total:</strong> ${features.length} businesses mapped
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderRatingHeatmap(data) {
            const heatmapData = data.heatmap_data || [];
            const stats = data.statistics || {};
            
            const highIntensity = heatmapData.filter(point => point.intensity > 0.7).length;
            const mediumIntensity = heatmapData.filter(point => point.intensity > 0.4 && point.intensity <= 0.7).length;
            const lowIntensity = heatmapData.filter(point => point.intensity <= 0.4).length;
            
            // Count by data type
            const businessPoints = stats.business_points || 0;
            const yelpPoints = stats.yelp_points || 0;
            const searchPoints = stats.search_points || 0;
            const regionalPoints = stats.regional_points || 0;
            
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: #374151; margin-bottom: 12px;">üî• Comprehensive Heatmap Data</h4>
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <div style="margin-bottom: 16px;">
                                <h5 style="color: #374151; margin-bottom: 8px;">üìä Data Sources (${heatmapData.length} total points)</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>üè¢ Business Ratings:</span>
                                        <span style="font-weight: 600; color: #3b82f6;">${businessPoints}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>‚≠ê Yelp Reviews:</span>
                                        <span style="font-weight: 600; color: #f59e0b;">${yelpPoints}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>üîç Search Volume:</span>
                                        <span style="font-weight: 600; color: #10b981;">${searchPoints}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>üåé Regional Interest:</span>
                                        <span style="font-weight: 600; color: #8b5cf6;">${regionalPoints}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <h5 style="color: #374151; margin-bottom: 8px;">üî• Intensity Distribution</h5>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 14px;">High Intensity (70%+)</span>
                                    <span style="background: #dc2626; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${highIntensity}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 14px;">Medium Intensity (40-70%)</span>
                                    <span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${mediumIntensity}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 14px;">Low Intensity (0-40%)</span>
                                    <span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${lowIntensity}</span>
                                </div>
                            </div>
                            
                            <div style="border-top: 1px solid #e5e7eb; padding-top: 12px;">
                                <div style="font-size: 12px; color: #6b7280;">
                                    <strong>Enhanced Algorithm:</strong><br>
                                    ‚Ä¢ Business ratings (40% weight)<br>
                                    ‚Ä¢ Yelp reviews (30% weight)<br>
                                    ‚Ä¢ Search volume (20% weight)<br>
                                    ‚Ä¢ Regional interest (10% weight)<br>
                                    <strong>Total Intensity:</strong> ${(stats.total_intensity || 0).toFixed(1)}<br>
                                    <strong>Average:</strong> ${((stats.average_intensity || 0) * 100).toFixed(1)}%
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #374151; margin-bottom: 12px;">üé® Enhanced Color Scheme</h4>
                        <div style="background: linear-gradient(to right, rgba(0,0,255,0), rgba(0,100,255,0.3), rgba(0,200,255,0.4), rgba(0,255,200,0.5), rgba(100,255,100,0.6), rgba(200,255,0,0.7), rgba(255,200,0,0.8), rgba(255,150,0,0.9), rgba(255,100,0,1), rgba(255,50,0,1), rgba(255,0,0,1)); height: 40px; border-radius: 8px; margin-bottom: 12px; position: relative;">
                            <div style="position: absolute; top: 45px; left: 0; font-size: 12px; color: #6b7280;">Low Activity</div>
                            <div style="position: absolute; top: 45px; right: 0; font-size: 12px; color: #6b7280;">High Activity</div>
                        </div>
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #6b7280; line-height: 1.6;">
                                <strong>Multi-Source Heatmap:</strong><br>
                                ‚Ä¢ üî¥ Red: High ratings + high search volume<br>
                                ‚Ä¢ üü° Yellow: Medium business activity<br>
                                ‚Ä¢ üü¢ Green: Good ratings, moderate activity<br>
                                ‚Ä¢ üîµ Blue: Lower activity areas<br>
                                ‚Ä¢ Click heatmap areas for detailed data<br>
                                ‚Ä¢ Zoom-responsive intensity<br>
                                ‚Ä¢ Real-time SerpApi data integration
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMarketDensity(data) {
            const areas = data.area_analysis || {};
            const areaEntries = Object.entries(areas).sort((a, b) => b[1].density_score - a[1].density_score);
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: #374151; margin-bottom: 12px;">üìä Market Density by Neighborhood</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            areaEntries.forEach(([areaName, stats], index) => {
                const densityColor = stats.density_score > 20 ? '#10b981' : stats.density_score > 10 ? '#f59e0b' : '#ef4444';
                
                html += `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: #1f2937;">${index + 1}. ${areaName}</strong>
                            <span style="background: ${densityColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                Score: ${stats.density_score.toFixed(1)}
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; font-size: 12px; color: #6b7280;">
                            <div>üè¢ ${stats.count} businesses</div>
                            <div>‚≠ê ${stats.avg_rating} avg rating</div>
                            <div>üí¨ ${stats.total_reviews} reviews</div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #374151; margin-bottom: 12px;">üéØ Market Insights</h4>
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <div style="margin-bottom: 16px;">
                                <h5 style="color: #374151; margin-bottom: 8px;">üèÜ Top Performing Areas</h5>
                                <div style="font-size: 12px; color: #6b7280;">
                                    ${areaEntries.slice(0, 3).map(([area, stats]) => 
                                        `${area}: ${stats.count} businesses, ${stats.avg_rating}‚òÖ rating`
                                    ).join('<br>')}
                                </div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <h5 style="color: #374151; margin-bottom: 8px;">üìà Market Opportunities</h5>
                                <div style="font-size: 12px; color: #6b7280;">
                                    Areas with lower density scores may present expansion opportunities for new moving companies.
                                </div>
                            </div>
                            <div style="border-top: 1px solid #e5e7eb; padding-top: 12px;">
                                <div style="font-size: 12px; color: #6b7280;">
                                    <strong>Density Score:</strong> Business count √ó Average rating<br>
                                    <strong>Analysis:</strong> ${Object.keys(areas).length} Miami neighborhoods<br>
                                    <strong>Update:</strong> Real-time market analysis
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderCompetitorClusters(data) {
            const clusters = data.clusters || [];
            const sortedClusters = clusters.sort((a, b) => b.size - a.size);
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: #374151; margin-bottom: 12px;">üéØ Competitor Clusters</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            sortedClusters.forEach((cluster, index) => {
                const clusterColor = cluster.size > 5 ? '#8b5cf6' : cluster.size > 3 ? '#3b82f6' : '#10b981';
                
                html += `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: #1f2937;">Cluster ${index + 1}</strong>
                            <span style="background: ${clusterColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                ${cluster.size} businesses
                            </span>
                        </div>
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
                            ‚≠ê ${cluster.avg_rating.toFixed(1)} avg rating | üí¨ ${cluster.total_reviews} total reviews
                        </div>
                        <div style="font-size: 11px; color: #9ca3af;">
                            <strong>Businesses:</strong> ${cluster.businesses.map(b => b[0]).join(', ')}
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #374151; margin-bottom: 12px;">üìä Cluster Analysis</h4>
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <div style="margin-bottom: 16px;">
                                <h5 style="color: #374151; margin-bottom: 8px;">üè¢ Cluster Distribution</h5>
                                <div style="font-size: 12px; color: #6b7280;">
                                    ${clusters.length} clusters identified across Miami<br>
                                    Average cluster size: ${(clusters.reduce((sum, c) => sum + c.size, 0) / clusters.length).toFixed(1)} businesses
                                </div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <h5 style="color: #374151; margin-bottom: 8px;">üéØ Strategic Insights</h5>
                                <div style="font-size: 12px; color: #6b7280;">
                                    ‚Ä¢ Large clusters indicate high competition areas<br>
                                    ‚Ä¢ Small clusters may represent market gaps<br>
                                    ‚Ä¢ Clustering helps identify expansion opportunities
                                </div>
                            </div>
                            <div style="border-top: 1px solid #e5e7eb; padding-top: 12px;">
                                <div style="font-size: 12px; color: #6b7280;">
                                    <strong>Algorithm:</strong> Proximity-based clustering (2km radius)<br>
                                    <strong>Total Clusters:</strong> ${clusters.length} identified<br>
                                    <strong>Coverage:</strong> Miami metropolitan area
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderRegionalInterestMap(data) {
            const features = data.features || [];
            const sortedFeatures = features.sort((a, b) => b.properties.rank - a.properties.rank);
            
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: #374151; margin-bottom: 12px;">üåé Top States by Interest</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${sortedFeatures.slice(0, 15).map((feature, index) => {
                                const interest = feature.properties.interest;
                                const rank = feature.properties.rank;
                                const interestColor = interest >= 80 ? '#10b981' : interest >= 60 ? '#f59e0b' : interest >= 40 ? '#f97316' : '#ef4444';
                                
                                return `
                                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px; background: white;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                            <strong style="color: #1f2937;">#${rank} ${feature.properties.region}</strong>
                                            <span style="background: ${interestColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                                ${interest}%
                                            </span>
                                        </div>
                                        <div style="font-size: 12px; color: #6b7280;">
                                            üìç Coordinates: ${feature.geometry.coordinates[1].toFixed(4)}, ${feature.geometry.coordinates[0].toFixed(4)}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #374151; margin-bottom: 12px;">üìä Interest Distribution</h4>
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <div style="margin-bottom: 16px;">
                                <h5 style="color: #374151; margin-bottom: 8px;">üéØ Interest Levels</h5>
                                <div style="font-size: 12px; color: #6b7280;">
                                    ‚Ä¢ High Interest (80%+): ${features.filter(f => f.properties.interest >= 80).length} states<br>
                                    ‚Ä¢ Medium Interest (60-79%): ${features.filter(f => f.properties.interest >= 60 && f.properties.interest < 80).length} states<br>
                                    ‚Ä¢ Low Interest (Below 60%): ${features.filter(f => f.properties.interest < 60).length} states
                                </div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <h5 style="color: #374151; margin-bottom: 8px;">üó∫Ô∏è Geographic Insights</h5>
                                <div style="font-size: 12px; color: #6b7280;">
                                    Interest data shows regional variations in moving company search behavior, 
                                    helping identify expansion opportunities and market potential.
                                </div>
                            </div>
                            <div style="border-top: 1px solid #e5e7eb; padding-top: 12px;">
                                <div style="font-size: 12px; color: #6b7280;">
                                    <strong>Data Source:</strong> SerpApi regional interest API<br>
                                    <strong>Total States:</strong> ${features.length} tracked<br>
                                    <strong>Update:</strong> Real-time interest tracking
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderInteractiveMapWithId(mapData, mapId) {
            return `
                <div style="position: relative;">
                    <div id="${mapId}" class="map-container"></div>
                    
                    <div class="map-controls">
                        <button class="map-control-btn active" onclick="toggleMapLayer('${mapId}', 'businesses')">
                            üìç Businesses
                        </button>
                        <button class="map-control-btn" onclick="toggleMapLayer('${mapId}', 'heatmap')">
                            üî• Heatmap
                        </button>
                        <button class="map-control-btn" onclick="toggleMapLayer('${mapId}', 'clusters')">
                            üéØ Clusters
                        </button>
                    </div>
                    
                    <div style="margin-top: 16px; padding: 12px; background: #f8fafc; border-radius: 6px; border-left: 4px solid #3b82f6;">
                        <strong style="color: #374151;">üí° Map Controls:</strong>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                            ‚Ä¢ Click any business marker to see details<br>
                            ‚Ä¢ Scroll to zoom, drag to pan<br>
                            ‚Ä¢ Use control buttons to toggle data layers<br>
                            ‚Ä¢ Real-time data from SerpApi database
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Initialize the map after rendering
        function initializeMiamiMap(mapId, mapData) {
            // Wait for mapbox to be available
            if (typeof mapboxgl === 'undefined') {
                console.error('Mapbox GL JS not loaded');
                return;
            }
            
            // Set access token - using a public token for demo purposes
            // For production, replace with your own Mapbox token from https://www.mapbox.com
            mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';
            
            const mapElement = document.getElementById(mapId);
            if (!mapElement) {
                console.error('Map element not found:', mapId);
                return;
            }
            
            // Create map with fallback style
            const map = new mapboxgl.Map({
                container: mapId,
                style: {
                    version: 8,
                    sources: {
                        'osm': {
                            type: 'raster',
                            tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                            tileSize: 256,
                            attribution: '¬© OpenStreetMap contributors'
                        }
                    },
                    layers: [{
                        id: 'osm',
                        type: 'raster',
                        source: 'osm'
                    }]
                },
                center: [-80.1918, 25.7617], // Miami coordinates
                zoom: 11
            });
            
            // Add navigation controls
            map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');
            
            // Store map instance
            if (!window.miamiMaps) window.miamiMaps = {};
            window.miamiMaps[mapId] = {
                map: map,
                data: mapData,
                activeLayers: {
                    businesses: true,
                    heatmap: false,
                    clusters: false
                }
            };
            
            // Load data when map is ready
            map.on('load', () => {
                renderMapData(mapId);
            });
        }
        
        // Render map data layers
        function renderMapData(mapId) {
            const mapInstance = window.miamiMaps[mapId];
            if (!mapInstance) return;
            
            const map = mapInstance.map;
            const data = mapInstance.data.data;
            const activeLayers = mapInstance.activeLayers;
            
            // Clear existing layers
            if (map.getLayer('businesses')) map.removeLayer('businesses');
            if (map.getLayer('heatmap')) map.removeLayer('heatmap');
            if (map.getLayer('clusters')) map.removeLayer('clusters');
            if (map.getSource('businesses')) map.removeSource('businesses');
            if (map.getSource('heatmap')) map.removeSource('heatmap');
            if (map.getSource('clusters')) map.removeSource('clusters');
            
            // Add business locations
            if (activeLayers.businesses && data.business_locations?.features) {
                map.addSource('businesses', {
                    type: 'geojson',
                    data: data.business_locations
                });
                
                map.addLayer({
                    id: 'businesses',
                    type: 'circle',
                    source: 'businesses',
                    paint: {
                        'circle-color': [
                            'case',
                            ['>=', ['get', 'rating'], 4.5], '#10b981',
                            ['>=', ['get', 'rating'], 4.0], '#f59e0b',
                            ['>=', ['get', 'rating'], 3.5], '#f97316',
                            '#ef4444'
                        ],
                        'circle-radius': [
                            'interpolate', ['linear'], ['get', 'reviews'],
                            0, 6,
                            500, 8,
                            1000, 12
                        ],
                        'circle-stroke-width': 2,
                        'circle-stroke-color': '#ffffff'
                    }
                });
                
                // Add click events for popups
                map.on('click', 'businesses', (e) => {
                    const feature = e.features[0];
                    const props = feature.properties;
                    
                    new mapboxgl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(`
                            <div style="max-width: 300px;">
                                <h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 14px; font-weight: 600;">${props.name}</h4>
                                <div style="margin-bottom: 4px; color: #059669; font-weight: 600;">‚≠ê ${props.rating}/5</div>
                                <div style="margin-bottom: 4px; color: #6b7280; font-size: 12px;">üí¨ ${props.reviews} reviews</div>
                                <div style="margin-bottom: 4px; color: #374151; font-size: 12px;">üìç ${props.address || 'N/A'}</div>
                                <div style="color: #3b82f6; font-size: 12px;">üìû ${props.phone || 'N/A'}</div>
                            </div>
                        `)
                        .addTo(map);
                });
                
                map.on('mouseenter', 'businesses', () => {
                    map.getCanvas().style.cursor = 'pointer';
                });
                
                map.on('mouseleave', 'businesses', () => {
                    map.getCanvas().style.cursor = '';
                });
            }
            
            // Add comprehensive heatmap
            if (activeLayers.heatmap && data.rating_heatmap?.heatmap_data) {
                const heatmapFeatures = data.rating_heatmap.heatmap_data.map(point => ({
                    type: 'Feature',
                    properties: {
                        intensity: point.intensity,
                        type: point.type,
                        weight: point.weight,
                        rating: point.rating || 0,
                        reviews: point.reviews || 0,
                        name: point.name || '',
                        keyword: point.keyword || '',
                        search_volume: point.search_volume || 0,
                        difficulty: point.difficulty || 0,
                        area: point.area || '',
                        interest_value: point.interest_value || 0
                    },
                    geometry: {
                        type: 'Point',
                        coordinates: point.coordinates
                    }
                }));
                
                map.addSource('heatmap', {
                    type: 'geojson',
                    data: {
                        type: 'FeatureCollection',
                        features: heatmapFeatures
                    }
                });
                
                // Enhanced heatmap with better color scheme and intensity
                map.addLayer({
                    id: 'heatmap',
                    type: 'heatmap',
                    source: 'heatmap',
                    paint: {
                        'heatmap-weight': [
                            'interpolate',
                            ['linear'],
                            ['get', 'intensity'],
                            0, 0,
                            0.1, 0.2,
                            0.3, 0.4,
                            0.5, 0.6,
                            0.7, 0.8,
                            1, 1
                        ],
                        'heatmap-intensity': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            0, 1,
                            9, 1.5,
                            11, 2,
                            13, 2.5,
                            15, 3
                        ],
                        'heatmap-color': [
                            'interpolate',
                            ['linear'],
                            ['heatmap-density'],
                            0, 'rgba(0,0,255,0)',      // Transparent blue
                            0.1, 'rgba(0,100,255,0.3)', // Light blue
                            0.2, 'rgba(0,200,255,0.4)', // Cyan
                            0.3, 'rgba(0,255,200,0.5)', // Light cyan
                            0.4, 'rgba(100,255,100,0.6)', // Light green
                            0.5, 'rgba(200,255,0,0.7)',   // Yellow-green
                            0.6, 'rgba(255,200,0,0.8)',   // Yellow
                            0.7, 'rgba(255,150,0,0.9)',   // Orange
                            0.8, 'rgba(255,100,0,1)',     // Red-orange
                            0.9, 'rgba(255,50,0,1)',      // Red
                            1, 'rgba(255,0,0,1)'          // Bright red
                        ],
                        'heatmap-radius': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            0, 5,
                            9, 10,
                            11, 15,
                            13, 20,
                            15, 25,
                            17, 30
                        ],
                        'heatmap-opacity': 0.8
                    }
                });
                
                // Add click events for heatmap points
                map.on('click', 'heatmap', (e) => {
                    const features = map.queryRenderedFeatures(e.point, { layers: ['heatmap'] });
                    if (features.length > 0) {
                        const feature = features[0];
                        const props = feature.properties;
                        
                        let popupContent = '<div style="max-width: 300px;">';
                        popupContent += `<h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 14px; font-weight: 600;">${props.type.replace('_', ' ').toUpperCase()}</h4>`;
                        popupContent += `<div style="margin-bottom: 4px; color: #059669; font-weight: 600;">üî• Intensity: ${(props.intensity * 100).toFixed(1)}%</div>`;
                        
                        if (props.type === 'business_rating') {
                            popupContent += `<div style="margin-bottom: 4px; color: #6b7280; font-size: 12px;">‚≠ê ${props.rating}/5 rating</div>`;
                            popupContent += `<div style="margin-bottom: 4px; color: #6b7280; font-size: 12px;">üí¨ ${props.reviews} reviews</div>`;
                            popupContent += `<div style="color: #374151; font-size: 12px;">üè¢ ${props.name}</div>`;
                        } else if (props.type === 'yelp_reviews') {
                            popupContent += `<div style="margin-bottom: 4px; color: #6b7280; font-size: 12px;">‚≠ê ${props.rating}/5 Yelp rating</div>`;
                            popupContent += `<div style="margin-bottom: 4px; color: #6b7280; font-size: 12px;">üí¨ ${props.reviews} Yelp reviews</div>`;
                            popupContent += `<div style="color: #374151; font-size: 12px;">üè¢ ${props.name}</div>`;
                        } else if (props.type === 'search_volume') {
                            popupContent += `<div style="margin-bottom: 4px; color: #6b7280; font-size: 12px;">üîç "${props.keyword}"</div>`;
                            popupContent += `<div style="margin-bottom: 4px; color: #6b7280; font-size: 12px;">üìä ${props.search_volume} monthly searches</div>`;
                            popupContent += `<div style="margin-bottom: 4px; color: #6b7280; font-size: 12px;">‚ö° ${props.difficulty}/100 difficulty</div>`;
                            popupContent += `<div style="color: #374151; font-size: 12px;">üìç ${props.area} area</div>`;
                        } else if (props.type === 'regional_interest') {
                            popupContent += `<div style="margin-bottom: 4px; color: #6b7280; font-size: 12px;">üåé ${props.interest_value}% regional interest</div>`;
                            popupContent += `<div style="color: #374151; font-size: 12px;">üìç ${props.area} area</div>`;
                        }
                        
                        popupContent += '</div>';
                        
                        new mapboxgl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(popupContent)
                            .addTo(map);
                    }
                });
                
                map.on('mouseenter', 'heatmap', () => {
                    map.getCanvas().style.cursor = 'pointer';
                });
                
                map.on('mouseleave', 'heatmap', () => {
                    map.getCanvas().style.cursor = '';
                });
            }
            
            // Add clusters
            if (activeLayers.clusters && data.competitor_clusters?.clusters) {
                const clusterFeatures = data.competitor_clusters.clusters.map(cluster => ({
                    type: 'Feature',
                    properties: {
                        size: cluster.size,
                        avg_rating: cluster.avg_rating,
                        total_reviews: cluster.total_reviews
                    },
                    geometry: {
                        type: 'Point',
                        coordinates: cluster.center
                    }
                }));
                
                map.addSource('clusters', {
                    type: 'geojson',
                    data: {
                        type: 'FeatureCollection',
                        features: clusterFeatures
                    }
                });
                
                map.addLayer({
                    id: 'clusters',
                    type: 'circle',
                    source: 'clusters',
                    paint: {
                        'circle-color': '#8b5cf6',
                        'circle-radius': ['interpolate', ['linear'], ['get', 'size'], 2, 15, 10, 30],
                        'circle-stroke-width': 3,
                        'circle-stroke-color': '#ffffff',
                        'circle-opacity': 0.6
                    }
                });
            }
        }
        
        // Toggle map layers
        function toggleMapLayer(mapId, layerName) {
            const mapInstance = window.miamiMaps[mapId];
            if (!mapInstance) return;
            
            mapInstance.activeLayers[layerName] = !mapInstance.activeLayers[layerName];
            
            // Update button state
            const button = event.target;
            button.classList.toggle('active');
            
            // Re-render map data
            renderMapData(mapId);
        }
        
        // Function to open full map (defined outside template string)
        function openFullMap() {
            window.open('/miami-map-template.html', '_blank');
        }

        // Marketing Analytics View - Data aggregation and insights
        async function loadMarketingAnalytics() {
            showLoading();
            currentView = 'marketing';
            
            try {
                // Load marketing analytics data
                const [analytics, bing, duckduckgo, scholar, finance, trends] = await Promise.all([
                    fetch(`${API_BASE}/marketing-analytics`).then(r => r.json()),
                    fetch(`${API_BASE}/bing-search`).then(r => r.json()),
                    fetch(`${API_BASE}/duckduckgo-search`).then(r => r.json()),
                    fetch(`${API_BASE}/google-scholar`).then(r => r.json()),
                    fetch(`${API_BASE}/google-finance`).then(r => r.json()),
                    fetch(`${API_BASE}/market-trends`).then(r => r.json())
                ]);

                hideLoading();

                let html = `
                    <div class="section" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                        <h2 style="margin: 0 0 12px 0;">üìä MARKETING ANALYTICS DASHBOARD</h2>
                        <div class="stat-grid">
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">35+</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">APIs Integrated</div>
                            </div>
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">5</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Analytics Types</div>
                            </div>
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">100%</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Real Data</div>
                            </div>
                            <div class="stat-box" style="background: rgba(255,255,255,0.2); color: white;">
                                <div class="stat-number">Smart</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Aggregation</div>
                            </div>
                        </div>
                        <p style="margin-top: 12px; font-size: 13px; opacity: 0.9;">
                            Last updated: ${new Date().toLocaleString()} | 
                            Cross-platform intelligence | 
                            Data-driven insights
                        </p>
                    </div>
                `;

                // Marketing Analytics Cards
                if (analytics.status === 'success' && analytics.analyses) {
                    const analyses = analytics.analyses;
                    
                    // Market Penetration Analysis
                    if (analyses.market_penetration) {
                        html += createSection(
                            'üéØ Market Penetration Analysis',
                            'Cross-platform business presence and market coverage analysis',
                            renderMarketPenetration(analyses.market_penetration),
                            { from_cache: false, age_minutes: 0, response_time_ms: 0, saved_to_db: true }
                        );
                    }
                    
                    // Competitive Intelligence
                    if (analyses.competitive_intelligence) {
                        html += createSection(
                            'üèÜ Competitive Intelligence',
                            'Market leaders, keyword opportunities, and industry news analysis',
                            renderCompetitiveIntelligence(analyses.competitive_intelligence),
                            { from_cache: false, age_minutes: 0, response_time_ms: 0, saved_to_db: true }
                        );
                    }
                    
                    // Content Strategy
                    if (analyses.content_strategy) {
                        html += createSection(
                            'üìù Content Strategy Insights',
                            'FAQ opportunities, content gaps, and keyword-based content ideas',
                            renderContentStrategy(analyses.content_strategy),
                            { from_cache: false, age_minutes: 0, response_time_ms: 0, saved_to_db: true }
                        );
                    }
                    
                    // Pricing Intelligence
                    if (analyses.pricing_intelligence) {
                        html += createSection(
                            'üí∞ Pricing Intelligence',
                            'Supply costs, price ranges, and market pricing analysis',
                            renderPricingIntelligence(analyses.pricing_intelligence),
                            { from_cache: false, age_minutes: 0, response_time_ms: 0, saved_to_db: true }
                        );
                    }
                    
                    // Trend Analysis
                    if (analyses.trend_analysis) {
                        html += createSection(
                            'üìà Trend Analysis',
                            'Search interest trends, regional analysis, and market volatility',
                            renderTrendAnalysis(analyses.trend_analysis),
                            { from_cache: false, age_minutes: 0, response_time_ms: 0, saved_to_db: true }
                        );
                    }
                }

                // Data Types Overview Card
                html += createSection(
                    'üìã Data Types & API Coverage',
                    'Complete overview of all available data types for marketing managers',
                    renderDataTypesOverview(),
                    { from_cache: false, age_minutes: 0, response_time_ms: 0, saved_to_db: true }
                );

                // Additional Search Engines
                html += createSection('üîç Bing Search Results', `Alternative search engine results. ${getTimestamp(bing)}`, renderSearchResults(bing), bing);
                html += createSection('ü¶Ü DuckDuckGo Results', `Privacy-focused search results. ${getTimestamp(duckduckgo)}`, renderSearchResults(duckduckgo), duckduckgo);
                html += createSection('üéì Academic Research', `Scholarly papers and research. ${getTimestamp(scholar)}`, renderScholarResults(scholar), scholar);
                html += createSection('üíπ Financial Data', `Market trends and financial news. ${getTimestamp(finance)}`, renderFinanceResults(finance), finance);
                html += createSection('üìä Market Trends', `Transportation industry trends. ${getTimestamp(trends)}`, renderMarketTrends(trends), trends);

                document.getElementById('dataContainer').innerHTML = html;
                
            } catch (error) {
                hideLoading();
                document.getElementById('dataContainer').innerHTML = `<div class="error-box">Error: ${error.message}</div>`;
            }
        }

        // Render functions for marketing analytics
        function renderMarketPenetration(data) {
            if (data.status !== 'success') return '<p style="color: #86868b;">No data available</p>';
            
            const platforms = data.platforms;
            const crossPlatform = data.cross_platform_analysis;
            
            return `
                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-number">${platforms.google_maps.businesses}</div>
                        <div class="stat-label">Google Maps</div>
                        <div style="font-size: 12px; color: #86868b;">${platforms.google_maps.total_reviews} reviews</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${platforms.yelp.businesses}</div>
                        <div class="stat-label">Yelp</div>
                        <div style="font-size: 12px; color: #86868b;">${platforms.yelp.total_reviews} reviews</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${crossPlatform.businesses_on_both}</div>
                        <div class="stat-label">Cross-Platform</div>
                        <div style="font-size: 12px; color: #86868b;">${crossPlatform.market_coverage}% coverage</div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <h4>Key Insights:</h4>
                    <ul style="font-size: 14px; color: #666;">
                        ${data.insights.map(insight => `<li>${insight}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function renderCompetitiveIntelligence(data) {
            if (data.status !== 'success') return '<p style="color: #86868b;">No data available</p>';
            
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>Top Competitors:</h4>
                        <table class="table">
                            <thead>
                                <tr><th>Company</th><th>Reviews</th><th>Market Share</th></tr>
                            </thead>
                            <tbody>
                                ${data.top_competitors.map(comp => `
                                    <tr>
                                        <td><strong>${comp.name}</strong></td>
                                        <td>${comp.reviews.toLocaleString()}</td>
                                        <td>${comp.market_share}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <h4>Keyword Opportunities:</h4>
                        <table class="table">
                            <thead>
                                <tr><th>Keyword</th><th>Difficulty</th><th>Opportunity</th></tr>
                            </thead>
                            <tbody>
                                ${data.keyword_opportunities.map(kw => `
                                    <tr>
                                        <td><strong>${kw.keyword}</strong></td>
                                        <td>${kw.difficulty}/100</td>
                                        <td style="color: ${kw.opportunity_level === 'High' ? '#10b981' : kw.opportunity_level === 'Medium' ? '#f59e0b' : '#ef4444'};">${kw.opportunity_level}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <h4>Insights:</h4>
                    <ul style="font-size: 14px; color: #666;">
                        ${data.insights.map(insight => `<li>${insight}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function renderContentStrategy(data) {
            if (data.status !== 'success') return '<p style="color: #86868b;">No data available</p>';
            
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>Content Opportunities:</h4>
                        <table class="table">
                            <thead>
                                <tr><th>Type</th><th>Title</th><th>Priority</th></tr>
                            </thead>
                            <tbody>
                                ${data.content_opportunities.slice(0, 5).map(opp => `
                                    <tr>
                                        <td>${opp.type}</td>
                                        <td><strong>${opp.title}</strong></td>
                                        <td style="color: ${opp.priority === 'High' ? '#10b981' : '#f59e0b'};">${opp.priority}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <h4>FAQ Questions:</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${data.faq_questions.map(faq => `
                                <div style="margin-bottom: 10px; padding: 8px; background: #f9fafb; border-radius: 4px;">
                                    <strong>${faq.question}</strong>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">${faq.answer}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <h4>Insights:</h4>
                    <ul style="font-size: 14px; color: #666;">
                        ${data.insights.map(insight => `<li>${insight}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function renderPricingIntelligence(data) {
            if (data.status !== 'success') return '<p style="color: #86868b;">No data available</p>';
            
            return `
                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-number">${data.pricing_metrics.total_products}</div>
                        <div class="stat-label">Products Tracked</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">$${data.pricing_metrics.average_price}</div>
                        <div class="stat-label">Average Price</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.price_distribution.budget}</div>
                        <div class="stat-label">Budget Options</div>
                        <div style="font-size: 12px; color: #86868b;">Under $10</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.price_distribution.premium}</div>
                        <div class="stat-label">Premium Options</div>
                        <div style="font-size: 12px; color: #86868b;">Over $50</div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <h4>Top Rated Products:</h4>
                    <table class="table">
                        <thead>
                            <tr><th>Product</th><th>Price</th><th>Rating</th><th>Source</th></tr>
                        </thead>
                        <tbody>
                            ${data.top_rated_products.map(product => `
                                <tr>
                                    <td><strong>${product.name}</strong></td>
                                    <td>$${product.price}</td>
                                    <td class="rating">${product.rating ? `‚≠ê ${product.rating}` : 'N/A'}</td>
                                    <td style="font-size: 12px;">${product.source}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 15px;">
                    <h4>Insights:</h4>
                    <ul style="font-size: 14px; color: #666;">
                        ${data.insights.map(insight => `<li>${insight}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function renderTrendAnalysis(data) {
            if (data.status !== 'success') return '<p style="color: #86868b;">No data available</p>';
            
            return `
                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-number">${data.search_trends.current_interest}</div>
                        <div class="stat-label">Current Interest</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.search_trends.trend_direction}</div>
                        <div class="stat-label">Trend Direction</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.search_trends.trend_percentage}%</div>
                        <div class="stat-label">Change</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.search_trends.volatility}</div>
                        <div class="stat-label">Volatility</div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <h4>Top Regional Markets:</h4>
                    <table class="table">
                        <thead>
                            <tr><th>Region</th><th>Interest</th><th>Rank</th><th>Potential</th></tr>
                        </thead>
                        <tbody>
                            ${data.regional_trends.slice(0, 10).map(region => `
                                <tr>
                                    <td><strong>${region.region}</strong></td>
                                    <td>${region.interest}</td>
                                    <td>#${region.rank}</td>
                                    <td style="color: ${region.market_potential === 'High' ? '#10b981' : region.market_potential === 'Medium' ? '#f59e0b' : '#ef4444'};">${region.market_potential}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 15px;">
                    <h4>Insights:</h4>
                    <ul style="font-size: 14px; color: #666;">
                        ${data.insights.map(insight => `<li>${insight}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function renderScholarResults(data) {
            if (!data.papers || data.papers.length === 0) return '<p style="color: #86868b;">No academic papers available</p>';
            
            return `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Paper Title</th>
                            <th>Authors</th>
                            <th>Year</th>
                            <th>Citations</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.papers.slice(0, 10).map(paper => `
                            <tr>
                                <td><strong>${paper.title}</strong></td>
                                <td style="font-size: 12px;">${paper.authors.join(', ')}</td>
                                <td style="font-size: 12px;">${paper.year}</td>
                                <td>${paper.citations}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <p style="font-size: 12px; color: #86868b; margin-top: 8px;">Showing 10 of ${data.total_papers} academic papers. Full data in database.</p>
            `;
        }

        function renderFinanceResults(data) {
            if (!data.news || data.news.length === 0) return '<p style="color: #86868b;">No financial data available</p>';
            
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>Financial News:</h4>
                        <table class="table">
                            <thead>
                                <tr><th>Title</th><th>Source</th><th>Date</th></tr>
                            </thead>
                            <tbody>
                                ${data.news.slice(0, 5).map(article => `
                                    <tr>
                                        <td><strong>${article.title}</strong></td>
                                        <td style="font-size: 12px;">${article.source}</td>
                                        <td style="font-size: 12px;">${article.date}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <h4>Stock Data:</h4>
                        <table class="table">
                            <thead>
                                <tr><th>Company</th><th>Price</th><th>Change</th></tr>
                            </thead>
                            <tbody>
                                ${data.stocks.slice(0, 5).map(stock => `
                                    <tr>
                                        <td><strong>${stock.name}</strong></td>
                                        <td>${stock.price}</td>
                                        <td style="color: ${stock.change_percent?.includes('+') ? '#10b981' : '#ef4444'};">${stock.change_percent}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderMarketTrends(data) {
            if (!data.trending_stocks || data.trending_stocks.length === 0) return '<p style="color: #86868b;">No market trends available</p>';
            
            return `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Ticker</th>
                            <th>Price</th>
                            <th>Change</th>
                            <th>Volume</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.trending_stocks.map(stock => `
                            <tr>
                                <td><strong>${stock.name}</strong></td>
                                <td style="font-size: 12px;">${stock.ticker}</td>
                                <td>${stock.price}</td>
                                <td style="color: ${stock.change_percent?.includes('+') ? '#10b981' : '#ef4444'};">${stock.change_percent}</td>
                                <td style="font-size: 12px;">${stock.volume}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <p style="font-size: 12px; color: #86868b; margin-top: 8px;">Showing ${data.total_trending} trending stocks in ${data.category} category.</p>
            `;
        }

        function renderDataTypesOverview() {
            const apiDataTypes = {
                "üîç Search & Rankings": {
                    "Google Search": ["Organic results", "Snippets", "Domain authority", "Position tracking"],
                    "Bing Search": ["Alternative results", "Cross-platform comparison", "Autocomplete suggestions"],
                    "DuckDuckGo": ["Privacy-focused results", "Instant answers", "Related searches"],
                    "Local Pack": ["3-pack results", "Local rankings", "Business info"]
                },
                "üè¢ Business Intelligence": {
                    "Google Maps": ["Business names", "Ratings & reviews", "Phone numbers", "Addresses", "GPS coordinates", "Hours", "Photos"],
                    "Yelp Reviews": ["Business profiles", "Review analysis", "Rating comparison", "Price ranges"],
                    "TripAdvisor": ["Storage facility reviews", "Traveler insights", "Rating trends"]
                },
                "üí° Keyword Research": {
                    "Keyword Suggestions": ["Autocomplete keywords", "Relevance scores", "Search volume indicators"],
                    "Related Searches": ["User behavior patterns", "Query expansion", "Content ideas"],
                    "People Also Ask": ["FAQ questions", "Featured snippet opportunities", "User intent"],
                    "Keyword Difficulty": ["Competition scores", "SEO opportunities", "Ranking potential"],
                    "Search Trends": ["Volume history", "Seasonal patterns", "Trend analysis"]
                },
                "üìä Analytics & Intelligence": {
                    "SERP Analysis": ["Feature detection", "Ad presence", "Local pack", "Knowledge graph"],
                    "Volume History": ["Time-series data", "Daily interest", "Trend direction", "Volatility"],
                    "Regional Interest": ["Geographic distribution", "State rankings", "Market potential"],
                    "Marketing Analytics": ["Market penetration", "Competitive intelligence", "Content strategy", "Pricing intelligence"]
                },
                "üíº Job Market": {
                    "Google Jobs": ["Job listings", "Salary data", "Company info", "Hiring patterns"],
                    "LinkedIn Jobs": ["Professional positions", "Company sizing", "Growth indicators"]
                },
                "üé• Content & Media": {
                    "YouTube Videos": ["Video content", "View counts", "Engagement metrics", "Content strategy"],
                    "Image Search": ["Visual content", "Branding analysis", "Marketing materials"],
                    "News Search": ["Industry news", "Competitor mentions", "Trend monitoring"]
                },
                "üõí E-commerce": {
                    "Google Shopping": ["Product listings", "Price comparison", "Retailer info"],
                    "Amazon Products": ["E-commerce analysis", "Product reviews", "Pricing trends"],
                    "Walmart Products": ["Retail pricing", "Supply costs", "Market analysis"]
                },
                "üì± App Stores": {
                    "Apple App Store": ["iOS apps", "App ratings", "Developer info", "Market penetration"],
                    "Google Play Store": ["Android apps", "Download stats", "User reviews"]
                },
                "üî¨ Innovation & Research": {
                    "Google Scholar": ["Academic papers", "Research citations", "Author profiles", "Innovation trends"],
                    "Google Patents": ["Patent filings", "Technology trends", "Innovation tracking"],
                    "Google Finance": ["Stock data", "Market trends", "Financial news", "Company analysis"]
                }
            };

            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            `;

            Object.entries(apiDataTypes).forEach(([category, apis]) => {
                html += `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background: #f9fafb;">
                        <h4 style="margin: 0 0 12px 0; color: #374151; font-size: 16px;">${category}</h4>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                `;

                Object.entries(apis).forEach(([apiName, dataTypes]) => {
                    html += `
                        <div style="border-left: 3px solid #3b82f6; padding-left: 8px;">
                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">${apiName}</div>
                            <div style="font-size: 12px; color: #6b7280; display: flex; flex-wrap: wrap; gap: 4px;">
                                ${dataTypes.map(type => `<span style="background: #e5e7eb; padding: 2px 6px; border-radius: 4px;">${type}</span>`).join('')}
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
                <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-radius: 8px;">
                    <h4 style="margin: 0 0 12px 0; color: #374151;">üìä Data Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; font-size: 14px;">
                        <div>
                            <strong>Total APIs:</strong> 35+ integrated<br>
                            <strong>Data Categories:</strong> 9 major categories<br>
                            <strong>Data Types:</strong> 50+ different data points
                        </div>
                        <div>
                            <strong>Update Frequency:</strong> Real-time + 15min cache<br>
                            <strong>Data Storage:</strong> SQLite database<br>
                            <strong>Validation:</strong> 100% real data only
                        </div>
                        <div>
                            <strong>Use Cases:</strong> SEO, Content, Pricing, Trends<br>
                            <strong>Target Audience:</strong> Marketing managers<br>
                            <strong>Data Quality:</strong> Live API calls only
                        </div>
                    </div>
                </div>
                <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
                    <strong style="color: #92400e;">üí° For Marketing Managers:</strong>
                    <div style="font-size: 14px; color: #92400e; margin-top: 4px;">
                        This comprehensive data coverage enables complete market intelligence, competitive analysis, 
                        content strategy development, pricing optimization, and trend monitoring for informed decision-making.
                    </div>
                </div>
            `;

            return html;
        }

        // Auto-load overview on page load
        window.addEventListener('load', () => {
            fetch(`${API_BASE}/status`)
                .then(r => r.json())
                .then(data => {
                    console.log('‚úÖ Server status:', data);
                    loadOverview();
                })
                .catch(error => {
                    document.getElementById('dataContainer').innerHTML = `
                        <div class="error-box">
                            <strong>‚ö†Ô∏è Server Not Running</strong><br><br>
                            Start server: <code>cd /Users/udishkolnik/API && .venv/bin/python3 API_Abilities/SerpApi/html/api_server.py</code>
                        </div>
                    `;
                });
        });
    </script>
</body>
</html>

